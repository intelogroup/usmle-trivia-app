import{r as e,j as t,m as s,o as r,aH as a,ay as i,A as o,aI as n,T as l,e as c,E as d,a as u,ax as x,aJ as m,aK as g,aL as p,aM as h,aN as b,aO as f,aP as y,h as w,u as j,b as v,aQ as N,aR as k,aS as _,H as q}from"./vendor-0A5iGyAR.js";import{s as S,l as C,b as z,u as I}from"./index-D5Tt7n0c.js";import{f as O,c as $,r as M,a as Q,Q as T,b as E,d as A}from"./QuizError-k0MqqUNg.js";import{u as L}from"./useQuizSounds-CP2U6g0S.js";const P=async(e,t)=>{try{console.log(`Quiz completed for user ${e}, session ${t}`);const s=await(async e=>{try{const{data:t,error:s}=await S.from("quiz_sessions").select("*").eq("user_id",e).eq("status","completed");if(s)return console.error("Error fetching quiz sessions:",s),{success:!1,error:s};if(!t||0===t.length){const t={user_id:e,total_quizzes_completed:0,total_questions_answered:0,total_correct_answers:0,total_points_earned:0,total_time_spent_seconds:0,overall_accuracy:0,average_quiz_score:0,best_quiz_score:0,current_streak:0,longest_streak:0,last_quiz_date:null,streak_start_date:null,category_stats:{},difficulty_stats:{}},{data:s,error:r}=await S.from("user_stats").upsert(t,{onConflict:"user_id"}).select().single();return{success:!0,data:s}}const r={user_id:e,total_quizzes_completed:t.length,total_questions_answered:t.reduce((e,t)=>e+(t.total_questions||0),0),total_correct_answers:t.reduce((e,t)=>e+(t.correct_answers||0),0),total_points_earned:t.reduce((e,t)=>e+(t.score||0),0),total_time_spent_seconds:t.reduce((e,t)=>e+(t.time_spent_seconds||0),0),last_quiz_date:t[t.length-1]?.completed_at};r.overall_accuracy=r.total_questions_answered>0?Math.round(r.total_correct_answers/r.total_questions_answered*100):0,r.average_quiz_score=t.length>0?Math.round(r.total_points_earned/t.length):0,r.best_quiz_score=t.length>0?Math.max(...t.map(e=>e.score||0)):0;const a=t.filter(e=>e.completed_at).sort((e,t)=>new Date(t.completed_at)-new Date(e.completed_at));let i=0,o=0,n=null;if(a.length>0){i=1,o=1,n=a[0].completed_at;for(let e=1;e<a.length;e++){const t=new Date(a[e-1].completed_at),s=new Date(a[e].completed_at);if(!(Math.floor((t-s)/864e5)<=1))break;i++,o=Math.max(o,i)}}r.current_streak=i,r.longest_streak=o,r.streak_start_date=n,r.category_stats={},r.difficulty_stats={};const{data:l,error:c}=await S.from("user_stats").upsert(r,{onConflict:"user_id"}).select().single();if(c)return console.error("Error upserting user stats:",c),{success:!1,error:c};const{error:d}=await S.from("profiles").update({total_points:r.total_points_earned,current_streak:r.current_streak,best_streak:r.longest_streak,last_active_date:new Date(r.last_quiz_date).toISOString().split("T")[0],last_active_at:r.last_quiz_date}).eq("id",e);return d&&console.error("Error updating profile:",d),{success:!0,data:l}}catch(t){return console.error("Error in updateUserStats:",t),{success:!1,error:t}}})(e);return s.success?console.log("User stats updated successfully after quiz completion"):console.error("Failed to update user stats after quiz completion:",s.error),s}catch(s){return console.error("Error in onQuizCompleted:",s),{success:!1,error:s}}};const H=({option:e,isSelected:i,isAnswered:o,isCorrectOption:n,handleSelect:l,disabled:c,showFeedback:d})=>{let u="bg-white/10 dark:bg-slate-900/40 border-white/20 dark:border-slate-700 text-white hover:bg-cyan-900/20 hover:border-cyan-400";return o?u=n?"border-green-500 bg-green-500/10 text-green-200":i?"border-red-500 bg-red-500/10 text-red-200":"border-white/10 dark:border-slate-700 opacity-60":i&&(u="border-cyan-400 bg-cyan-400/10 text-cyan-200"),t.jsxs(s.button,{layout:!0,className:`w-full flex items-center justify-between px-5 py-4 rounded-2xl border transition-all duration-200 text-base font-medium focus:outline-none focus:ring-2 focus:ring-cyan-400 ${u} shadow-sm`,onClick:()=>!c&&l(e.id),disabled:c,whileHover:c?{}:{scale:1.03},whileTap:c?{}:{scale:.98},children:[t.jsx("span",{children:e.text}),d&&o&&(n?t.jsx(r,{className:"w-5 h-5 text-green-400"}):i?t.jsx(a,{className:"w-5 h-5 text-red-400"}):null)]})},R=()=>t.jsx("div",{className:"w-full h-40 bg-gradient-to-br from-slate-700/40 to-slate-800/60 animate-pulse rounded-xl mb-6"}),G=({seconds:e})=>t.jsx("div",{className:"absolute top-0 right-0 mt-[-18px] mr-[-10px]",children:t.jsxs("div",{className:"flex items-center gap-1 px-3 py-1 rounded-full bg-cyan-500/90 shadow-lg text-white text-sm font-semibold border-2 border-white/30 backdrop-blur-md",children:[t.jsx(i,{className:"w-4 h-4 mr-1 opacity-80"}),t.jsxs("span",{children:[e,"s"]})]})}),K=({currentQuestion:i,selectedOption:n,isAnswered:l,handleOptionSelect:c,showExplanations:d=!1,timedOut:u=!1,progress:x=0,total:m=10,secondsLeft:g=null})=>{const[p,h]=e.useState(!1),b=e=>e?e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>"):"",f=n===i.correct_option_id;return t.jsx(s.div,{layout:!0,className:"relative mx-auto max-w-xl w-full p-0 sm:p-0",style:{zIndex:1},children:t.jsxs("div",{className:"backdrop-blur-xl bg-white/20 dark:bg-slate-900/70 border border-white/20 dark:border-slate-700 rounded-3xl shadow-2xl px-6 py-8 sm:px-10 sm:py-12 flex flex-col items-stretch",children:[t.jsxs("div",{className:"w-full mb-6 relative",children:[t.jsx("div",{className:"h-1.5 w-full bg-white/10 rounded-full overflow-hidden",children:t.jsx(s.div,{className:"h-full bg-gradient-to-r from-indigo-400 to-cyan-400 rounded-full",initial:{width:0},animate:{width:`${Math.round(x/m*100)}%`},transition:{duration:.5}})}),t.jsxs("div",{className:"text-xs text-white/70 mt-1 text-right",children:[x," / ",m]}),"number"==typeof g&&t.jsx(G,{seconds:g})]}),i.image_url&&t.jsxs("div",{className:"flex justify-center mb-6",children:[!p&&t.jsx(R,{}),t.jsx("img",{src:z(i.image_url,{width:600}),alt:"Question",className:"max-h-40 rounded-xl shadow-lg object-contain transition-opacity duration-300 "+(p?"opacity-100":"opacity-0"),onLoad:()=>h(!0),style:{display:p?"block":"none",minHeight:"160px"}})]}),t.jsx("div",{className:"mb-8",children:t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white text-center leading-snug drop-shadow",dangerouslySetInnerHTML:{__html:b(i.question_text)}})}),t.jsx("div",{className:"flex flex-col gap-4 mb-4",children:i.options?.map(e=>t.jsx(H,{option:e,isSelected:n===e.id,isAnswered:l,isCorrectOption:e.id===i.correct_option_id,handleSelect:c,disabled:l,showFeedback:!0},e.id))}),t.jsx(o,{children:d&&l&&i.explanation&&t.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.4},className:"mt-6 px-5 py-4 rounded-2xl flex items-center gap-3 shadow bg-slate-900/80 border border-white/10",children:[f?t.jsx(r,{className:"w-7 h-7 text-green-400 shrink-0"}):t.jsx(a,{className:"w-7 h-7 text-red-400 shrink-0"}),t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold mb-1 text-white text-lg",children:f?"Correct!":"Incorrect"}),t.jsx("div",{className:"text-white/80 text-base",dangerouslySetInnerHTML:{__html:b(i.explanation)}})]})]})})]})})},D=({timeLeft:e,formatTime:r,isLowTime:a=!1,progressPercentage:c=100,timerKey:d,initialTime:u=60,showProgressBar:x=!0,size:m="large"})=>{const g=e/u*100,p=g<=10?"critical":g<=25?"warning":g<=50?"caution":"normal",h=(()=>{const e={container:"relative flex items-center justify-center rounded-xl transition-all duration-300",text:"font-bold tabular-nums",progress:"absolute inset-0 rounded-xl transition-all duration-300"};return{...{small:{container:`${e.container} h-12 w-24 text-sm`,text:`${e.text} text-sm`,icon:"w-3 h-3",progress:e.progress},normal:{container:`${e.container} h-16 w-32 text-lg`,text:`${e.text} text-lg`,icon:"w-4 h-4",progress:e.progress},large:{container:`${e.container} h-20 w-40 text-xl`,text:`${e.text} text-xl`,icon:"w-5 h-5",progress:e.progress}}[m],...{normal:{container:"bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg",progress:"bg-gradient-to-r from-blue-400 to-blue-500",glow:""},caution:{container:"bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg",progress:"bg-gradient-to-r from-yellow-400 to-orange-400",glow:"shadow-yellow-200"},warning:{container:"bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg",progress:"bg-gradient-to-r from-orange-400 to-red-400",glow:"shadow-orange-200 animate-pulse"},critical:{container:"bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg",progress:"bg-gradient-to-r from-red-400 to-red-500",glow:"shadow-red-200 animate-pulse"}}[p]}})();return t.jsxs("div",{className:"fixed top-4 left-1/2 transform -translate-x-1/2 z-30 flex flex-col items-center space-y-2",children:[t.jsxs(s.div,{variants:{normal:{scale:1,rotate:0},caution:{scale:1.02,rotate:0},warning:{scale:1.05,rotate:[-1,1,-1,0]},critical:{scale:1.1,rotate:[-2,2,-2,2,0]}},animate:p,transition:{duration:"critical"===p?.5:"warning"===p?.8:1,repeat:"critical"===p||"warning"===p?1/0:0,repeatType:"reverse"},className:`${h.container} ${h.glow} relative overflow-hidden`,children:[x&&t.jsx("div",{className:`${h.progress} opacity-30`,style:{width:`${Math.max(0,Math.min(100,g))}%`,transition:"width 1s linear"}}),t.jsxs("div",{className:"relative z-10 flex items-center space-x-2",children:[(()=>{switch(p){case"critical":return t.jsx(l,{className:`${h.icon} animate-bounce`});case"warning":return t.jsx(l,{className:`${h.icon} animate-pulse`});case"caution":return t.jsx(n,{className:h.icon});default:return t.jsx(i,{className:h.icon})}})(),t.jsx(s.span,{variants:{normal:{scale:1},caution:{scale:1},warning:{scale:[1,1.1,1]},critical:{scale:[1,1.2,1]}},animate:p,transition:{duration:.3,repeat:"critical"===p?1/0:0,repeatType:"reverse"},className:h.text,children:r?r(e):`${e}s`})]}),t.jsx(o,{children:"critical"===p&&t.jsx(s.div,{initial:{scale:1,opacity:.5},animate:{scale:1.5,opacity:0},exit:{scale:1,opacity:0},transition:{duration:1,repeat:1/0,ease:"easeOut"},className:"absolute inset-0 bg-red-400 rounded-xl"})})]},d),x&&t.jsx("div",{className:"w-full max-w-xs",children:t.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:t.jsx(s.div,{className:"h-full rounded-full transition-all duration-1000 ease-linear "+("critical"===p?"bg-red-500":"warning"===p?"bg-orange-500":"caution"===p?"bg-yellow-500":"bg-blue-500"),style:{width:`${Math.max(0,Math.min(100,g))}%`},animate:{boxShadow:"critical"===p?["0 0 0 rgba(239, 68, 68, 0)","0 0 20px rgba(239, 68, 68, 0.6)","0 0 0 rgba(239, 68, 68, 0)"]:"warning"===p?["0 0 0 rgba(249, 115, 22, 0)","0 0 15px rgba(249, 115, 22, 0.4)","0 0 0 rgba(249, 115, 22, 0)"]:"none"},transition:{boxShadow:{duration:1,repeat:1/0,ease:"easeInOut"}}})})}),t.jsx(o,{children:("warning"===p||"critical"===p)&&t.jsx(s.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"text-center text-xs font-medium px-3 py-1 rounded-full "+("critical"===p?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200"),children:"critical"===p?"Time almost up!":"Running low on time"})}),t.jsx(o,{children:"normal"===p&&g>75&&t.jsx(s.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},className:"text-center text-xs font-medium text-green-600 dark:text-green-400",children:"Great pace! Keep it up 🚀"})})]})},F=({trigger:r,duration:a=3e3})=>{const[i,n]=e.useState(!1);e.useEffect(()=>{if(r){n(!0);const e=setTimeout(()=>n(!1),a);return()=>clearTimeout(e)}},[r,a]);const l=Array.from({length:50},(e,t)=>({id:t,left:100*Math.random(),delay:2*Math.random(),duration:2+2*Math.random(),color:["bg-red-500","bg-blue-500","bg-green-500","bg-yellow-500","bg-purple-500","bg-pink-500"][Math.floor(6*Math.random())]}));return t.jsx(o,{children:i&&t.jsx("div",{className:"fixed inset-0 pointer-events-none z-50 overflow-hidden",children:l.map(e=>t.jsx(s.div,{className:`absolute w-2 h-2 ${e.color} rounded-sm`,style:{left:`${e.left}%`,top:"-10px"},initial:{y:-20,rotate:0,opacity:1},animate:{y:window.innerHeight+20,rotate:360,opacity:0},transition:{duration:e.duration,delay:e.delay,ease:"easeIn"}},e.id))})})},B=({accuracy:e,performance:r})=>t.jsxs("div",{className:"text-center mb-8",children:[t.jsx(F,{trigger:e>=80,duration:4e3}),t.jsx(s.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring",stiffness:200},className:"inline-flex items-center justify-center w-16 h-16 rounded-full text-white mb-4 "+(e>=80?"bg-gradient-to-r from-yellow-500 to-orange-500":"bg-purple-600"),children:e>=80?t.jsx(c,{className:"w-8 h-8"}):t.jsx(n,{className:"w-8 h-8"})}),t.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2",children:e>=80?"🎉 Outstanding! 🎉":"Quick Quiz Complete!"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:e>=80?"You absolutely crushed it!":r.message}),e>=80&&t.jsx(s.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.8},className:"text-sm text-purple-600 dark:text-purple-400 mt-2",children:"🌟 You're ready for the real thing! 🌟"})]}),U=({score:e,questionCount:r,accuracy:a,performance:i})=>t.jsx(s.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.3},className:`${i.bgColor} rounded-2xl p-4 sm:p-8 mb-8 text-center`,children:t.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center sm:space-x-6 space-y-4 sm:space-y-0",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:`text-4xl sm:text-6xl font-bold ${i.color} mb-1 sm:mb-2`,children:e}),t.jsxs("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:["out of ",r]})]}),t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:`text-4xl sm:text-6xl font-bold ${i.color} mb-1 sm:mb-2`,children:[a,"%"]}),t.jsx("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:"accuracy"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:`text-4xl sm:text-6xl font-bold ${i.color} mb-1 sm:mb-2`,children:i.grade}),t.jsx("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:"grade"})]})]})}),W=({score:e,accuracy:r})=>t.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[t.jsx(c,{className:"w-8 h-8 text-yellow-500 mx-auto mb-2"}),t.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:e>=8?"Quiz Master!":e>=6?"Good Work!":"Keep Going!"})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[t.jsx(d,{className:"w-8 h-8 text-blue-500 mx-auto mb-2"}),t.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:r>=80?"Sharpshooter":r>=60?"On Target":"Practice Makes Perfect"})]}),t.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[t.jsx(i,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),t.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:"Quick & Focused"})]})]}),Y=({userAnswers:e})=>t.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 mb-8",children:[t.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Detailed Review"}),t.jsx("div",{className:"space-y-6",children:e.map((e,o)=>t.jsx(s.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.6+.1*o},className:"border border-gray-200 dark:border-gray-700 rounded-xl p-4 sm:p-6",children:t.jsxs("div",{className:"flex items-start space-x-4",children:[t.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center "+(e.isCorrect?"bg-green-100 dark:bg-green-900/30":e.timedOut?"bg-orange-100 dark:bg-orange-900/30":"bg-red-100 dark:bg-red-900/30"),children:e.isCorrect?t.jsx(r,{className:"w-5 h-5 text-green-600"}):e.timedOut?t.jsx(i,{className:"w-5 h-5 text-orange-600"}):t.jsx(a,{className:"w-5 h-5 text-red-600"})}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:["Question ",o+1]}),e.timedOut&&t.jsx("span",{className:"text-sm font-medium text-orange-600 dark:text-orange-400",children:"Time ran out"})]}),t.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:e.question.question_text}),t.jsx("div",{className:"space-y-2 mb-4",children:e.question.options.map(s=>{const r=s.id===e.selectedOptionId,a=s.id===e.question.correct_option_id;return t.jsx("div",{className:"p-3 rounded-lg border-2 "+(r&&a?"border-green-500 bg-green-50 dark:bg-green-900/20":r&&!a?"border-red-500 bg-red-50 dark:bg-red-900/20":a?"border-green-300 bg-green-50 dark:bg-green-900/10":"border-gray-200 dark:border-gray-600"),children:t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-1 sm:space-y-0",children:[t.jsx("span",{className:"text-gray-900 dark:text-white",children:s.text}),t.jsxs("div",{className:"flex space-x-2",children:[r&&t.jsx("span",{className:"text-xs sm:text-sm font-medium text-blue-600",children:"Your Answer"}),a&&t.jsx("span",{className:"text-xs sm:text-sm font-medium text-green-600",children:"Correct"})]})]})},s.id)})}),e.question.explanation&&t.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[t.jsx("h4",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"Explanation"}),t.jsx("p",{className:"text-blue-800 dark:text-blue-200",children:e.question.explanation})]})]})]})},o))})]}),J={whileTap:{scale:.93},whileHover:{scale:1.04},transition:{type:"spring",stiffness:400,damping:20}},V=({accuracy:e,onRestart:r,onGoHome:a,handleShare:i,onButtonPress:o})=>t.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},className:"flex flex-col sm:flex-row gap-4 justify-center",children:[t.jsxs(s.button,{...J,onClick:e=>{o?.(),r(e)},className:"flex items-center justify-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:[t.jsx(u,{className:"w-5 h-5"}),t.jsx("span",{children:"Try Again"})]}),t.jsx(s.button,{...J,onClick:e=>{o?.(),a(e)},className:"flex items-center justify-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:t.jsx("span",{children:"Back to Home"})}),e>=80&&t.jsxs(s.button,{...J,onClick:e=>{o?.(),i(e)},className:"flex items-center justify-center space-x-2 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:[t.jsx(x,{className:"w-5 h-5"}),t.jsx("span",{children:"Share Success!"})]})]});const X=["#06b6d4","#f59e42","#10b981","#f43f5e","#6366f1","#eab308"],Z=({score:e,questionCount:r,accuracy:a,userAnswers:i,quizSession:o,quizConfig:n,timeSpent:l,onRestart:c,onGoHome:d})=>{const u=a>=80?{grade:"A",color:"text-green-600",bgColor:"bg-green-100",message:"Excellent! USMLE ready!"}:a>=70?{grade:"B",color:"text-blue-600",bgColor:"bg-blue-100",message:"Good job! Keep it up!"}:a>=60?{grade:"C",color:"text-yellow-600",bgColor:"bg-yellow-100",message:"Not bad! More practice needed!"}:{grade:"D",color:"text-red-600",bgColor:"bg-red-100",message:"Keep practicing! You'll improve!"};l&&(Math.floor(l/60),(l%60).toString().padStart(2,"0"));const x=function(e){let t=0,s=0,r=0,a=0;return e.forEach(e=>{e.isCorrect?(r++,t=Math.max(t,r),a=0):(a++,s=Math.max(s,a),r=0)}),{maxCorrect:t,maxWrong:s}}(i),w=function(e){const t={};return e.forEach(e=>{const s=e.question.topic||e.question.system||e.question.subject||"Other";t[s]||(t[s]={topic:s,correct:0,total:0}),t[s].total++,e.isCorrect&&t[s].correct++}),Object.values(t)}(i),j=function(e){return e.map((e,t)=>({q:t+1,time:e.timeSpent||0,correct:e.isCorrect}))}(i);return t.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900/20 dark:to-indigo-900/20",children:t.jsx("div",{className:"container mx-auto px-4 py-8",children:t.jsxs(s.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-4xl mx-auto",children:[t.jsx(B,{accuracy:a,performance:u}),t.jsx(U,{score:e,questionCount:r,accuracy:a,performance:u}),t.jsx(W,{score:e,accuracy:a}),t.jsxs(s.div,{initial:{opacity:0,y:24},animate:{opacity:1,y:0},transition:{delay:.3},className:"bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 mb-8 shadow",children:[t.jsx("h3",{className:"text-xl font-bold mb-2",children:"Performance Analytics"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold mb-1",children:"Per-topic Breakdown"}),t.jsx(m,{width:"100%",height:180,children:t.jsxs(g,{data:w,margin:{left:-20,right:10},children:[t.jsx(p,{dataKey:"topic",fontSize:12,tick:{fill:"#64748b"},interval:0,angle:-15,dy:10}),t.jsx(h,{allowDecimals:!1,fontSize:12,tick:{fill:"#64748b"}}),t.jsx(b,{formatter:(e,t)=>"correct"===t?`${e} correct`:e}),t.jsx(f,{dataKey:"correct",fill:"#06b6d4",children:w.map((e,s)=>t.jsx(y,{fill:X[s%X.length]},e.topic))})]})})]}),t.jsxs("div",{children:[t.jsx("div",{className:"font-semibold mb-1",children:"Time per Question (s)"}),t.jsx(m,{width:"100%",height:180,children:t.jsxs(g,{data:j,margin:{left:-20,right:10},children:[t.jsx(p,{dataKey:"q",fontSize:12,tick:{fill:"#64748b"}}),t.jsx(h,{allowDecimals:!1,fontSize:12,tick:{fill:"#64748b"}}),t.jsx(b,{formatter:e=>`${e}s`}),t.jsx(f,{dataKey:"time",fill:"#6366f1",children:j.map((e,s)=>t.jsx(y,{fill:e.correct?"#10b981":"#f43f5e"},e.q))})]})})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-6 mt-6",children:[t.jsxs("div",{className:"bg-cyan-50 dark:bg-cyan-900/20 rounded-xl px-4 py-2 font-semibold",children:["Longest Correct Streak: ",t.jsx("span",{className:"text-green-600",children:x.maxCorrect})]}),t.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 rounded-xl px-4 py-2 font-semibold",children:["Longest Incorrect Streak: ",t.jsx("span",{className:"text-red-600",children:x.maxWrong})]})]})]}),t.jsx(Y,{userAnswers:i}),t.jsx(V,{accuracy:a,onRestart:c,onGoHome:d,handleShare:()=>{const t=`Just scored ${e}/${r} (${a}%) on a USMLE ${n?.quizMode||"Quick"} Quiz! 🎉`;navigator.share?navigator.share({title:"USMLE Quiz Results",text:t,url:window.location.origin}):(navigator.clipboard.writeText(`${t} Check it out at ${window.location.origin}`),alert("Results copied to clipboard!"))}})]})})})},ee=()=>{const{state:r}=w(),a=j(),{user:i,loading:n}=I();if(n)return t.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading..."})]})});if(!i)return a("/auth/login"),null;const{questions:l,currentIndex:c,currentQuestion:d,userAnswers:u,isAnswered:x,selectedOption:m,timedOut:g,loading:p,error:h,isComplete:b,timeLeft:f,handleOptionSelect:y,quizSession:S}=function({userId:t,categoryId:s="mixed",questionCount:r=10,difficulty:a=null,timePerQuestion:i=60}){const[o,n]=e.useState([]),[l,c]=e.useState(0),[d,u]=e.useState([]),[x,m]=e.useState(!1),[g,p]=e.useState(null),[h,b]=e.useState(!1),[f,y]=e.useState(!0),[w,j]=e.useState(null),[v,N]=e.useState(null),[k,_]=e.useState(!1),[q,S]=e.useState(i),z=e.useRef(null);e.useEffect(()=>{if(!t)return y(!1),void j(new Error("User authentication required to start quiz"));let e=!0;return y(!0),j(null),console.log("Fetching questions with params:",{userId:t,categoryId:s,questionCount:r,difficulty:a}),O({userId:t,categoryId:s,questionCount:r,difficulty:a}).then(async r=>{if(e&&(console.log("Fetched questions:",r.length,r),n(r),r.length>0)){const a=await $({userId:t,sessionType:"quick",totalQuestions:r.length,categoryName:"mixed"!==s?s:null,timePerQuestion:i,autoAdvance:!0,showExplanations:!1,settings:{}});e&&N(a)}}).catch(t=>{e&&j(t)}).finally(()=>{e&&y(!1)}),()=>{e=!1}},[t,s,r,a,i]),e.useEffect(()=>{if(!(x||k||f))return z.current=setInterval(()=>{S(e=>e<=1?(clearInterval(z.current),b(!0),m(!0),0):e-1)},1e3),()=>clearInterval(z.current)},[x,k,f]);const I=e.useCallback(e=>{if(x||h||k)return;p(e),m(!0),clearInterval(z.current);const s=o[l],r=e===s.correct_option_id,a=i-q,n={userId:t,questionId:s.id,selectedOptionId:e,isCorrect:r,timeSpent:a,responseOrder:l+1,question:s,timedOut:!1};u(e=>[...e,n]),v&&M({sessionId:v.id,userId:n.userId,questionId:n.questionId,selectedOptionId:n.selectedOptionId,isCorrect:n.isCorrect,timeSpent:n.timeSpent,responseOrder:n.responseOrder}).catch(e=>{console.error("Failed to record quiz response:",e)})},[x,h,k,o,l,q,i,v]);e.useEffect(()=>{if(h&&!x&&!k){const e=o[l],s={userId:t,questionId:e.id,selectedOptionId:null,isCorrect:!1,timeSpent:i,responseOrder:l+1,question:e,timedOut:!0};u(e=>[...e,s]),m(!0),v&&M({sessionId:v.id,userId:s.userId,questionId:s.questionId,selectedOptionId:s.selectedOptionId,isCorrect:s.isCorrect,timeSpent:s.timeSpent,responseOrder:s.responseOrder}).catch(e=>{console.error("Failed to record timeout response:",e)})}},[h,x,k,o,l,i,v]);const T=e.useCallback(()=>{m(!1),p(null),b(!1),S(i),c(e=>e+1)},[i]),E=e.useCallback(async()=>{if(_(!0),clearInterval(z.current),v?.id)try{const s=d.filter(e=>e.isCorrect).length,r=d.reduce((e,t)=>e+(t.timeSpent||0),0),a=d.reduce((e,t)=>t.isCorrect&&t.question?.points?e+t.question.points:e,0);await Q(v.id,{correctAnswers:s,totalTimeSeconds:r,pointsEarned:a,completed:!0});try{await P(t,v.id),C.info("Leaderboard stats updated after quiz completion")}catch(e){C.warn("Failed to update leaderboard stats (non-critical):",e)}C.info("QuickQuiz session completed successfully",{sessionId:v.id,correctAnswers:s,totalTimeSeconds:r,pointsEarned:a})}catch(w){C.error("Failed to complete QuickQuiz session",{error:w.message,sessionId:v?.id})}},[v,d,t]);return e.useEffect(()=>{if(x&&!k){const e=l===o.length-1,t=setTimeout(()=>{e?E():T()},h?1e3:500);return()=>clearTimeout(t)}},[x,k,l,o.length,E,T,h]),{questions:o,currentIndex:l,currentQuestion:o[l],userAnswers:d,isAnswered:x,selectedOption:g,timedOut:h,loading:f,error:w,isComplete:k,timeLeft:q,handleOptionSelect:I,moveToNextQuestion:T,completeQuiz:E,quizSession:v}}({userId:i.id,categoryId:r?.categoryId||"mixed",questionCount:r?.questionCount||10,difficulty:r?.difficulty||null,timePerQuestion:60}),[z,H]=v.useState(()=>"true"===localStorage.getItem("quizMuted")),{playCorrect:R,playWrong:G,playTimesUp:F,playComplete:B}=L(z);v.useEffect(()=>{x&&!g&&(m===d?.correct_option_id?R():G()),g&&F()},[x,g,m,d,R,G,F]),v.useEffect(()=>{b&&B()},[b,B]),l.length;const U=()=>a(-1),W=()=>a("/"),Y=u.filter(e=>e.isCorrect).length,J=Math.round(Y/Math.max(1,u.length)*100),V=u.reduce((e,t)=>e+t.timeSpent,0);return p?t.jsx(T,{message:""}):h&&0===l.length?t.jsx(E,{error:h,onRetry:()=>window.location.reload(),onGoBack:U}):0===l.length?t.jsx(E,{error:{code:"NO_QUESTIONS",message:"No questions available."},onRetry:()=>window.location.reload(),onGoBack:U}):b?t.jsx(Z,{score:Y,questionCount:l.length,accuracy:J,userAnswers:u,quizSession:S,quizConfig:{...r,quizMode:"quick"},timeSpent:V,onRestart:()=>{a("/quick-quiz",{state:r,replace:!0}),window.location.reload()},onGoHome:W}):t.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-800 dark:to-purple-900/20",children:[t.jsx("div",{className:"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700",children:t.jsxs("div",{className:"container mx-auto px-4 py-3 flex items-center justify-between",children:[t.jsx("button",{onClick:U,className:"text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 p-2 rounded",children:t.jsx(N,{className:"w-5 h-5"})}),t.jsx("h1",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Quick Quiz"}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>{H(e=>(localStorage.setItem("quizMuted",!e),!e))},className:"p-2 rounded",title:z?"Unmute":"Mute",children:z?t.jsx(k,{className:"w-5 h-5"}):t.jsx(_,{className:"w-5 h-5"})}),t.jsx("button",{onClick:W,className:"text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 p-2 rounded",children:t.jsx(q,{className:"w-5 h-5"})})]})]})}),t.jsxs("div",{className:"container mx-auto px-4 pt-8 pb-2 flex flex-col items-center",children:[t.jsx(D,{timeLeft:f,formatTime:e=>`${e}s`,isLowTime:f<=15,progressPercentage:f/60*100,timerKey:c,initialTime:60,showProgressBar:!1,size:"small"}),t.jsx(A,{current:c+1,total:l.length,progress:(c+1)/l.length,showDetailed:!1,size:"small"})]}),t.jsx("div",{className:"container mx-auto px-4 pb-8",children:t.jsx(o,{mode:"wait",children:d?t.jsx(s.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},children:t.jsx(K,{currentQuestion:d,isAnswered:x,selectedOption:m,handleOptionSelect:y,showExplanations:!1,timedOut:g,secondsLeft:f},d.id)},d.id):!p&&t.jsxs("div",{className:"text-center text-gray-600 dark:text-gray-400 py-10",children:[t.jsx("p",{children:"No question available to display. Please try again or select a different category."}),t.jsx("button",{onClick:()=>a(-1),className:"mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Go Back"})]})})})]})};export{ee as default};
