import{aq as e,ar as t,r,u as a}from"./vendor-ChsRwzkX.js";import{q as i,i as s,s as n}from"./index-CwYISt8q.js";import{Q as o}from"./questionService-DCaLMc6P.js";const c=r=>{e();const a=t({queryKey:i.userActivity(r),queryFn:async()=>{if(!r)return{isNewUser:!0};const{data:e,error:t}=await n.from("user_question_history").select("*").eq("user_id",r).limit(1);if(t)throw t;return{isNewUser:!e||0===e.length,hasActivity:e&&e.length>0}},enabled:!!r,staleTime:12e4}),o=t({queryKey:i.userStats(r),queryFn:async()=>{if(!r)return null;const{data:e,error:t}=await n.rpc("get_user_stats",{p_user_id:r});if(t)return null;if(e&&e.length>0){const t=e[0];return{totalQuestions:t.total_questions_attempted||0,accuracy:t.accuracy_percentage||0,studyTime:Math.round(2*t.total_questions_attempted/60*10)/10||0,currentStreak:0}}return null},enabled:!!r&&a.data?.hasActivity,staleTime:3e5}),c=t({queryKey:i.recentActivity(r),queryFn:async()=>{if(!r)return[];const{data:e,error:t}=await n.from("quiz_sessions").select("\n          *,\n          quiz_responses (\n            questions (\n              question_tags (\n                tags (name)\n              )\n            )\n          )\n        ").eq("user_id",r).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(4);if(t)throw t;return e?.map(e=>{const t=(e.quiz_responses?.flatMap(e=>e.questions?.question_tags?.map(e=>e.tags.name)||[])||[])[0]||"General",r=`${e.correct_answers||0}/${e.total_questions||0}`,a=new Date(e.completed_at),i=new Date,s=Math.floor((i-a)/36e5);return{category:t,score:r,time:s<24?`${s}h ago`:`${Math.floor(s/24)}d ago`,color:{Cardiology:"text-red-500",Neurology:"text-purple-500",Pharmacology:"text-green-500",Anatomy:"text-blue-500",Pathology:"text-orange-500",Biochemistry:"text-teal-500",Physiology:"text-indigo-500",General:"text-gray-500"}[t]||"text-gray-500"}})||[]},enabled:!!r&&a.data?.hasActivity,staleTime:3e5});return{isLoading:a.isLoading,isError:a.isError||o.isError||c.isError,error:a.error||o.error||c.error,isNewUser:a.data?.isNewUser??!0,userStats:o.data||{totalQuestions:0,accuracy:0,studyTime:0,currentStreak:0},recentActivity:c.data||[],isFromCache:a.isStale||o.isStale||c.isStale,isRefreshing:a.isFetching||o.isFetching||c.isFetching,refetch:()=>{a.refetch(),a.data?.hasActivity&&(o.refetch(),c.refetch())},invalidate:()=>s.userData(r)}},u=(a,n=!0)=>{e();const c=t({queryKey:i.categories(),queryFn:()=>o.fetchCategories(),staleTime:6e5}),u=t({queryKey:i.userProgress(a),queryFn:()=>o.getProgressMap(a),enabled:!!a&&n&&c.isSuccess,staleTime:3e5}),l=r.useMemo(()=>{if(!c.data||!Array.isArray(c.data))return console.warn("Categories data is not available or not an array"),[];const e=u.data||{};return c.data.map(t=>t&&"object"==typeof t?{id:t.id||`category-${Math.random()}`,title:t.name||t.title||"Unknown Category",name:t.name||t.title||"Unknown Category",description:t.description||`Study ${(t.name||"this").toLowerCase()} concepts and practice questions`,icon:t.icon_name||"BookOpen",color:t.color_code||t.color,type:t.type||"subject",questionCount:Math.max(0,t.question_count||0),difficulty:t.question_count>=50?"Advanced":t.question_count>=20?"Intermediate":"Beginner",isPopular:(t.question_count||0)>20,progress:e[t.id]??0,accuracy:0,completionRate:0,lastUsed:null,isFavorite:!1,isHighYield:(t.question_count||0)>50}:(console.warn("Invalid category data:",t),null)).filter(Boolean).filter(e=>(e.questionCount||0)>0||!1)},[c.data,u.data]);return{isLoading:c.isLoading,isError:c.isError||u.isError,error:c.error||u.error,data:l,isFromCache:c.isStale||u.isStale,isRefreshing:c.isFetching||u.isFetching,refetch:()=>{c.refetch(),n&&a&&u.refetch()},invalidate:()=>s.categories()}},l=()=>{const e=a(),t=r.useCallback((t,r={})=>{const{replace:a=!1,state:i=null,transitionName:s="page-transition",duration:n=300}=r;if(!document.startViewTransition)return void e(t,{replace:a,state:i});document.documentElement.classList.add(`transition-${s}`);const o=document.startViewTransition(()=>{e(t,{replace:a,state:i})});return o.finished.finally(()=>{document.documentElement.classList.remove(`transition-${s}`)}),o},[e]),i=r.useCallback((e,r,a={})=>t("/quiz",{state:{categoryId:e,categoryName:r,...a},transitionName:"quiz-enter"}),[t]),s=r.useCallback(()=>t("/",{transitionName:"home-enter"}),[t]),n=r.useCallback(()=>t("/profile",{transitionName:"profile-enter"}),[t]);return{transitionTo:t,transitionToQuiz:i,transitionToHome:s,transitionToProfile:n,isSupported:!!document.startViewTransition}};export{c as a,u as b,l as u};
