import{j as e,m as a,b6 as t,y as s,r,f as l,b as d}from"./vendor-CVvCghmu.js";import{s as n}from"./index-DwP4RzE3.js";const i=({chat:s,isActive:r,onClick:l})=>{return e.jsxs(a.div,{onClick:l,className:"flex items-center p-3 rounded-2xl cursor-pointer transition-all duration-200 "+(r?"bg-blue-500/20 dark:bg-blue-500/30":"hover:bg-gray-100 dark:hover:bg-gray-800/50"),whileTap:{scale:.98},children:[e.jsxs("div",{className:"relative w-12 h-12 mr-4",children:["archive"===s.avatar?e.jsx("div",{className:"w-full h-full rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center",children:e.jsx(t,{size:20,className:"text-gray-500 dark:text-gray-400"})}):s.avatar?e.jsx("img",{src:s.avatar,alt:s.name,className:"w-full h-full rounded-full object-cover"}):e.jsx("div",{className:"w-full h-full rounded-full bg-purple-500 flex items-center justify-center",children:e.jsx("span",{className:"text-white font-bold text-lg",children:(d=s.name,d.split(" ").map(e=>e[0]).join(""))})}),s.unread>0&&e.jsx("div",{className:"absolute top-0 right-0 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white dark:border-gray-900",children:s.unread})]}),e.jsxs("div",{className:"flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-gray-800 dark:text-gray-100 truncate",children:s.name}),e.jsx("p",{className:"text-xs "+(s.unread>0?"text-blue-500 dark:text-blue-400 font-semibold":"text-gray-400 dark:text-gray-500"),children:s.time})]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:s.message})]})]});var d},c=({chats:a,selectedChat:t,onSelectChat:r,searchTerm:l,onSearchChange:d,searchResults:n,searchLoading:c,onStartChat:o,chatLoadingId:h})=>e.jsxs("div",{className:"w-full md:w-1/3 lg:w-1/4 h-full border-r border-gray-200 dark:border-gray-700/60 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700/60 sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-10",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Chats"}),e.jsxs("div",{className:"relative mt-4",children:[e.jsx(s,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search users...",className:"w-full bg-gray-100 dark:bg-gray-800 border-none rounded-xl pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-blue-500 transition",value:l,onChange:d})]}),c&&e.jsx("div",{className:"text-xs text-gray-400 mt-2",children:"Searching..."}),n.length>0&&e.jsx("div",{className:"mt-2 bg-white dark:bg-gray-800 rounded-xl shadow p-2 max-h-60 overflow-y-auto",children:n.map(a=>e.jsxs("div",{className:"flex items-center justify-between py-2 px-2 hover:bg-blue-50 dark:hover:bg-blue-900/30 rounded-lg transition",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[a.avatar_url?e.jsx("img",{src:a.avatar_url,alt:a.display_name,className:"w-8 h-8 rounded-full object-cover"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold",children:a.display_name?.[0]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-sm",children:a.display_name}),e.jsx("div",{className:"text-xs text-gray-400",children:a.email})]})]}),e.jsx("button",{className:"ml-2 px-3 py-1 bg-blue-500 text-white rounded-lg text-xs font-semibold hover:bg-blue-600 disabled:opacity-60",onClick:()=>o(a.id),disabled:h===a.id,children:h===a.id?"Loading...":"Chat"})]},a.id))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-1",children:a.map(a=>e.jsx(i,{chat:a,isActive:t?.id===a.id,onClick:()=>r(a)},a.id))})]}),o=({selectedChat:a,messages:t,messageInput:s,onMessageInputChange:d,onSendMessage:n,sending:i,otherUserProfile:c})=>{const o=r.useRef(null);return r.useEffect(()=>{o.current&&o.current.scrollIntoView({behavior:"smooth"})},[t]),e.jsx("div",{className:"hidden md:flex flex-1 flex-col",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center p-3 border-b border-gray-200 dark:border-gray-700/60 sticky top-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur-md z-10 gap-3",children:[c?.avatar_url?e.jsx("img",{src:c.avatar_url,className:"w-10 h-10 rounded-full object-cover",alt:c.display_name}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-purple-500 flex items-center justify-center text-white font-bold",children:c?.display_name?.[0]||"?"}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-bold text-lg",children:c?.display_name||"Chat"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Online"})]})]}),e.jsxs("div",{className:"flex-1 p-6 flex flex-col gap-2 overflow-y-auto bg-gray-50 dark:bg-gray-800/50",children:[0===t.length?e.jsxs("div",{className:"text-center text-gray-500 my-8",children:[e.jsx(l,{size:48,className:"mx-auto text-gray-400"}),e.jsx("p",{className:"mt-2",children:"No messages yet."})]}):t.map(a=>{const t=a.sender_id===supabase.auth.user()?.id;return e.jsxs("div",{className:"flex items-end gap-2 "+(t?"justify-end":"justify-start"),children:[!t&&c?.avatar_url&&e.jsx("img",{src:c.avatar_url,className:"w-7 h-7 rounded-full object-cover mb-1",alt:c.display_name}),e.jsxs("div",{className:"rounded-2xl px-4 py-2 max-w-xs shadow text-sm relative "+(t?"bg-blue-500 text-white rounded-br-md":"bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-md"),children:[a.content,e.jsx("div",{className:"text-[10px] text-right text-gray-300 mt-1",children:new Date(a.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),e.jsx("span",{className:`absolute bottom-0 ${t?"right-0":"left-0"} w-3 h-3 ${t?"bg-blue-500":"bg-white dark:bg-gray-700"} rounded-bl-full rounded-br-full`,style:{transform:t?"translateY(50%) rotate(45deg)":"translateY(50%) rotate(-45deg)"}})]})]},a.id)}),e.jsx("div",{ref:o})]}),e.jsx("div",{className:"p-4 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700/60",children:e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",placeholder:"Type a message...",className:"w-full bg-gray-100 dark:bg-gray-800 border-none rounded-xl pl-4 pr-12 py-3 focus:ring-2 focus:ring-blue-500 transition",value:s,onChange:d,onKeyDown:e=>{"Enter"===e.key&&n()},disabled:i}),e.jsx("button",{className:"absolute right-3 top-1/2 -translate-y-1/2 text-blue-500 hover:text-blue-600 disabled:opacity-60",onClick:n,disabled:i||!s.trim(),children:e.jsx(l,{size:22})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx(l,{size:64,className:"mx-auto"}),e.jsx("h2",{className:"mt-4 text-xl font-medium",children:"Select a chat"}),e.jsx("p",{children:"Start a conversation from the list on the left."})]})})})},h=[{id:1,name:"Dr. Evelyn Reed",message:"Just reviewing the latest cardiology case studies. Fascinating stuff!",time:"10:42 AM",unread:2,avatar:"https://images.unsplash.com/photo-1580894908361-967195033215?w=100&h=100&fit=crop&crop=faces"},{id:2,name:"Anatomy Study Group",message:"Alex: Don't forget the pop quiz on cranial nerves tomorrow!",time:"9:15 AM",unread:5,avatar:null},{id:3,name:"Dr. Ben Carter",message:"Great work on the presentation today.",time:"Yesterday",unread:0,avatar:"https://images.unsplash.com/photo-1556157382-97eda2d62296?w=100&h=100&fit=crop&crop=faces"},{id:4,name:"Pharmacology Q&A",message:"You: Can anyone explain the mechanism of action for loop diuretics?",time:"Yesterday",unread:0,avatar:null},{id:5,name:"Julia Martinez",message:"See you at the library later?",time:"Wednesday",unread:0,avatar:"https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=faces"},{id:6,name:"Archived Chats",message:"You have 3 archived conversations.",time:"Tuesday",unread:0,avatar:"archive"}],u=()=>{const{selectedChat:a,setSelectedChat:t,searchTerm:s,setSearchTerm:l,searchResults:i,searchLoading:u,chatLoadingId:m,messages:g,messageInput:x,setMessageInput:f,sending:b,otherUserProfile:p,handleStartChat:y,handleSendMessage:v}=(()=>{const[e,a]=r.useState(null),[t,s]=r.useState(""),[l,i]=r.useState([]),[c,o]=r.useState(!1),[h,u]=r.useState(null),[m,g]=r.useState([]),[x,f]=r.useState(""),[b,p]=r.useState(!1),[y,v]=r.useState(null),j=d(),w=new URLSearchParams(j.search).get("chatId");return r.useEffect(()=>{if(!t)return void i([]);o(!0);const e=setTimeout(async()=>{const{data:e,error:a}=await n.from("profiles").select("id, display_name, email, avatar_url").ilike("display_name",`%${t}%`).limit(10);i(e||[]),o(!1)},300);return()=>clearTimeout(e)},[t]),r.useEffect(()=>{if(!e||!e.id)return void g([]);let a=!0;(async()=>{const{data:t}=await n.from("messages").select("id, sender_id, content, created_at").eq("chat_id",e.id).order("created_at",{ascending:!0});a&&g(t||[])})();const t=n.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`chat_id=eq.${e.id}`},e=>{g(a=>[...a,e.new])}).subscribe();return()=>{a=!1,n.removeChannel(t)}},[e]),r.useEffect(()=>{w&&n.from("chats").select("*").eq("id",w).single().then(({data:e})=>{e&&a(e)})},[w]),r.useEffect(()=>{e&&e.id&&n.from("chat_members").select("user_id").eq("chat_id",e.id).then(async({data:e})=>{const a=n.auth.user(),t=e?.find(e=>e.user_id!==a?.id);if(t){const{data:e}=await n.from("profiles").select("id, display_name, avatar_url").eq("id",t.user_id).single();v(e)}else v(null)})},[e]),{selectedChat:e,setSelectedChat:a,searchTerm:t,setSearchTerm:s,searchResults:l,searchLoading:c,chatLoadingId:h,messages:m,messageInput:x,setMessageInput:f,sending:b,otherUserProfile:y,handleStartChat:async e=>{u(e);const t=n.auth.user();if(!t)return alert("You must be logged in to start a chat."),void u(null);const{data:r,error:l}=await n.rpc("find_or_create_one_to_one_chat",{user1:t.id,user2:e});if(l)return alert("Error creating chat: "+l.message),void u(null);const{data:d}=await n.from("chats").select("*").eq("id",r).single();d&&(a({...d,isNew:!0}),s(""),i([])),u(null)},handleSendMessage:async()=>{if(!x.trim()||!e?.id)return;p(!0);const a=n.auth.user();if(!a)return alert("You must be logged in to send messages."),void p(!1);const{error:t}=await n.from("messages").insert({chat_id:e.id,sender_id:a.id,content:x.trim()});t?alert("Error sending message: "+t.message):f(""),p(!1)}}})();return e.jsxs("div",{className:"flex h-full bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200",children:[e.jsx(c,{chats:h,selectedChat:a,onSelectChat:t,searchTerm:s,onSearchChange:e=>l(e.target.value),searchResults:i,searchLoading:u,onStartChat:y,chatLoadingId:m}),e.jsx(o,{selectedChat:a,messages:g,messageInput:x,onMessageInputChange:e=>f(e.target.value),onSendMessage:v,sending:b,otherUserProfile:p})]})};export{u as default};
