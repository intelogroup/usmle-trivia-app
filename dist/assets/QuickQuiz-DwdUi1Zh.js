import{r as e,aq as t,aE as s,u as a,j as r,aF as i,aG as n,aH as o,al as l,aI as c,an as d,m as u,aJ as m,av as x,aK as g,q as h,L as p,aL as y,aM as f,T as b,o as w,aN as j,aO as v,ak as N,b as q,aP as k}from"./vendor-ChsRwzkX.js";import{s as _,u as S}from"./index-CwYISt8q.js";import{u as z,Q as C,a as I,b as Q}from"./QuizError-DN33deu4.js";import{Q as T}from"./questionService-DCaLMc6P.js";import{E}from"./enhancedQuestionService-CN-qEh-K.js";class M{constructor(e){this.userId=e,this.validateUserId()}validateUserId(){if(!this.userId)throw new Error("User ID is required")}async verifyUserAuth(){const{data:{user:e},error:t}=await _.auth.getUser();if(t||!e)throw new Error("User not authenticated");if(e.id!==this.userId)throw new Error("Security violation: User ID mismatch");return e}async createQuizSession(e){await this.verifyUserAuth();const{data:t,error:s}=await _.from("quiz_sessions").insert({user_id:this.userId,quiz_type:e.quiz_type||"practice",total_questions:e.total_questions,settings:e.settings||{},started_at:(new Date).toISOString()}).select().single();if(s)throw console.error("Error creating quiz session:",s),new Error(`Failed to create quiz session: ${s.message}`);return t}async recordQuizResponses(e,t){await this.verifyUserAuth(),await this.verifySessionOwnership(e);const s=t.map((t,s)=>({session_id:e,question_id:t.question_id,selected_option_id:t.selected_option_id,is_correct:t.is_correct,response_order:s+1,time_spent_seconds:t.time_spent_seconds||0,created_at:(new Date).toISOString()})),{error:a}=await _.from("quiz_responses").insert(s);if(a)throw console.error("Error recording quiz responses:",a),new Error(`Failed to record quiz responses: ${a.message}`);await this.updateQuestionHistory(t)}async updateQuestionHistory(e){const t=e.map(e=>({user_id:this.userId,question_id:e.question_id,last_answered_correctly:e.is_correct,last_seen_at:(new Date).toISOString(),times_seen:1})),{error:s}=await _.from("user_question_history").upsert(t,{onConflict:"user_id,question_id"});if(s)throw console.error("Error updating question history:",s),new Error(`Failed to update question history: ${s.message}`)}async completeQuizSession(e,t,s={}){await this.verifyUserAuth(),await this.verifySessionOwnership(e);const{error:a}=await _.from("quiz_sessions").update({score:t,correct_answers:s.correct_answers,completed_at:(new Date).toISOString(),duration_seconds:s.duration_seconds,metadata:s}).eq("id",e).eq("user_id",this.userId);if(a)throw console.error("Error completing quiz session:",a),new Error(`Failed to complete quiz session: ${a.message}`);await this.updateUserStats()}async verifySessionOwnership(e){const{data:t,error:s}=await _.from("quiz_sessions").select("user_id").eq("id",e).single();if(s)throw new Error(`Session verification failed: ${s.message}`);if(t.user_id!==this.userId)throw new Error("Security violation: Session does not belong to user");return!0}async getUserStats(){await this.verifyUserAuth();try{const{data:e,error:t}=await _.rpc("get_user_stats",{p_user_id:this.userId});if(t)throw t;return e?.[0]||{total_questions_attempted:0,correct_questions:0,incorrect_questions:0,accuracy_percentage:0}}catch(e){throw console.error("Error fetching user stats:",e),new Error(`Failed to fetch user stats: ${e.message}`)}}async getCategoryProgress(e=null){await this.verifyUserAuth();let t=_.from("user_question_history").select("\n        question_id,\n        last_answered_correctly,\n        last_seen_at,\n        times_seen,\n        questions!inner (\n          question_tags (\n            tag_id,\n            tags (\n              id,\n              name\n            )\n          )\n        )\n      ").eq("user_id",this.userId);e&&"mixed"!==e&&(t=t.eq("questions.question_tags.tag_id",e));const{data:s,error:a}=await t.order("last_seen_at",{ascending:!1});if(a)throw console.error("Error fetching category progress:",a),new Error(`Failed to fetch category progress: ${a.message}`);return s||[]}async getRecentSessions(e=10){await this.verifyUserAuth();const{data:t,error:s}=await _.from("quiz_sessions").select("\n        id,\n        quiz_type,\n        score,\n        total_questions,\n        correct_answers,\n        completed_at,\n        duration_seconds,\n        settings\n      ").eq("user_id",this.userId).not("completed_at","is",null).order("completed_at",{ascending:!1}).limit(e);if(s)throw console.error("Error fetching recent sessions:",s),new Error(`Failed to fetch recent sessions: ${s.message}`);return t||[]}async updateUserStats(){try{const{error:e}=await _.rpc("update_user_statistics",{p_user_id:this.userId});e&&console.warn("Failed to update user statistics:",e)}catch(e){console.warn("Error updating user statistics:",e)}}async getLearningRecommendations(){await this.verifyUserAuth();try{const{data:e,error:t}=await _.rpc("get_learning_recommendations",{p_user_id:this.userId});if(t)throw t;return e||[]}catch(e){return console.error("Error fetching learning recommendations:",e),[]}}async performSecurityAudit(){await this.verifyUserAuth();const e={userDataIsolated:!1,rlsPoliciesWorking:!1,dataLeakageDetected:!1,errors:[]};try{const{data:t,error:s}=await _.from("user_question_history").select("user_id").eq("user_id",this.userId).limit(1);s?e.errors.push(`Cannot access own data: ${s.message}`):e.userDataIsolated=!0;const{data:a,error:r}=await _.from("user_question_history").select("user_id").neq("user_id",this.userId).limit(1);a&&a.length>0?(e.dataLeakageDetected=!0,e.errors.push("Can access other users' data - RLS policies not working")):e.rlsPoliciesWorking=!0}catch(t){e.errors.push(`Security audit failed: ${t.message}`)}return e}}const O=({categoryName:e,currentQuestionIndex:t,totalQuestions:s,score:u,isOffline:m,isFetching:x,timeLeft:g,isTimed:h,quizMode:p,quizType:y})=>{const f=a(),b=(()=>{switch(p){case"quick":return{icon:c,label:"Quick Quiz",color:"text-blue-600"};case"timed":return{icon:d,label:"Timed Test",color:"text-orange-600"};case"blitz":return{icon:c,label:"Blitz Quiz",color:"text-yellow-600"};case"custom":return{icon:d,label:"Custom Quiz",color:"text-purple-600"};default:return{icon:c,label:"Quiz",color:"text-gray-600"}}})(),w=b.icon;return r.jsxs("div",{className:"flex items-center justify-between mb-3",children:[r.jsx("button",{onClick:()=>f(-1),className:"p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors","aria-label":"Go back",children:r.jsx(i,{size:20})}),r.jsxs("div",{className:"text-center flex-1",children:[r.jsxs("div",{className:"flex items-center justify-center gap-2 mb-1",children:[r.jsx(w,{className:`w-4 h-4 ${b.color}`}),r.jsx("span",{className:"text-base font-bold text-gray-900 dark:text-white",children:e||b.label}),m&&r.jsx("div",{className:"flex items-center text-orange-500",title:"Using offline questions",children:r.jsx(n,{size:16})}),x&&r.jsx("div",{className:"flex items-center text-blue-500",title:"Updating questions",children:r.jsx(o,{size:16,className:"animate-pulse"})})]}),r.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-gray-500 dark:text-gray-400",children:[r.jsxs("span",{children:["Question ",t+1," / ",s]}),p&&r.jsxs(r.Fragment,{children:[r.jsx("span",{children:"â€¢"}),r.jsx("span",{className:b.color,children:b.label})]})]})]}),r.jsx("div",{className:"text-right",children:h&&null!==g?r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(l,{size:16,className:g<30?"text-red-500":"text-gray-500"}),r.jsx("div",{className:"text-base font-bold "+(g<30?"text-red-500":g<60?"text-yellow-500":"text-gray-700 dark:text-gray-300"),children:(e=>{if(null==e)return"--:--";const t=e%60;return`${Math.floor(e/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`})(g)})]}):r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Score"}),r.jsxs("div",{className:"text-base font-bold text-gray-900 dark:text-white",children:[u,"/",s]})]})})]})},$=({preloadStatus:t="loading",cacheStats:s={},isPreloading:a=!1,estimatedTime:i=null,loadingStage:n="questions",showDetailedProgress:d=!0,onCancel:f=null})=>{const[b,w]=e.useState(0),[j,v]=e.useState(n),[N,q]=e.useState(!1);e.useEffect(()=>{let e;if("loading"===t){let t=0;const s=()=>{if(t<100){const a=3*Math.random()+1;t=Math.min(t+a,100),w(t),v(t<40?"questions":t<70?"images":t<90?"cache":"complete"),e=setTimeout(s,100+100*Math.random())}};s()}else w(100);return()=>{e&&clearTimeout(e)}},[t]),e.useEffect(()=>{const e=setTimeout(()=>{q(!0)},3e3);return()=>clearTimeout(e)},[]);const k={initial:{width:0},animate:{width:`${b}%`,transition:{duration:.3,ease:"easeOut"}}},_={initial:{scale:1,opacity:.7},animate:{scale:[1,1.05,1],opacity:[.7,1,.7],transition:{duration:2,repeat:1/0,ease:"easeInOut"}}};return r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900/20 dark:to-purple-900/20 flex items-center justify-center p-4",children:r.jsxs(u.div,{variants:{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1,transition:{duration:.5,ease:"easeOut"}},exit:{opacity:0,scale:1.1,transition:{duration:.3}}},initial:"initial",animate:"animate",exit:"exit",className:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-md w-full relative overflow-hidden",children:[r.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-blue-500/5 to-purple-500/5 dark:from-blue-400/5 dark:to-purple-400/5"}),r.jsxs("div",{className:"relative z-10 text-center mb-8",children:[r.jsx(u.div,{variants:_,animate:"animate",className:"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mb-4 text-white",children:(S=j,{questions:r.jsx(x,{className:"w-5 h-5"}),images:r.jsx(g,{className:"w-5 h-5"}),cache:r.jsx(c,{className:"w-5 h-5"}),complete:r.jsx(y,{className:"w-5 h-5"})}[S]||r.jsx(p,{className:"w-5 h-5 animate-spin"}))}),r.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-2",children:"cache-hit"===t?"Loading from Cache":"Preparing Quiz"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:(e=>({questions:"Fetching quiz questions...",images:"Loading question images...",cache:"Optimizing for performance...",complete:"Almost ready!"}[e]||"Loading..."))(j)})]}),r.jsxs("div",{className:"relative z-10 mb-6",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm text-gray-600 dark:text-gray-300 mb-2",children:[r.jsx("span",{children:"Progress"}),r.jsxs("span",{children:[Math.round(b),"%"]})]}),r.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden",children:r.jsx(u.div,{variants:k,animate:"animate",className:"h-full bg-gradient-to-r from-blue-500 to-purple-600 rounded-full relative",children:r.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"})})})]}),r.jsx("div",{className:"relative z-10 flex justify-between mb-6",children:["questions","images","cache","complete"].map((e,t)=>{const s=j===e,a=["questions","images","cache","complete"].indexOf(j)>t;return r.jsxs("div",{className:"flex flex-col items-center",children:[r.jsx(u.div,{animate:{scale:s?1.2:1,backgroundColor:a||s?"#3B82F6":"#E5E7EB"},className:"w-3 h-3 rounded-full mb-1 "+(a||s?"bg-blue-500":"bg-gray-300 dark:bg-gray-600")}),r.jsx("span",{className:"text-xs "+(a||s?"text-blue-600 dark:text-blue-400 font-medium":"text-gray-400"),children:"questions"===e?"Questions":"images"===e?"Images":"cache"===e?"Cache":"Ready"})]},e)})}),d&&r.jsx(m,{children:r.jsx(u.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"relative z-10 bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 mb-6",children:r.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(x,{className:"w-4 h-4 text-blue-500"}),r.jsxs("span",{className:"text-gray-600 dark:text-gray-300",children:["Cache: ",s.questionCacheSize||0," questions"]})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(g,{className:"w-4 h-4 text-green-500"}),r.jsxs("span",{className:"text-gray-600 dark:text-gray-300",children:["Images: ",s.imageCacheSize||0," cached"]})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(h,{className:"w-4 h-4 text-purple-500"}),r.jsxs("span",{className:"text-gray-600 dark:text-gray-300",children:["Hit Rate: ",Math.round(s.cacheHitRatio||0),"%"]})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:["cache-hit"===t?r.jsx(c,{className:"w-4 h-4 text-yellow-500"}):r.jsx(o,{className:"w-4 h-4 text-blue-500"}),r.jsx("span",{className:"text-gray-600 dark:text-gray-300",children:"cache-hit"===t?"Instant Load":"Network Load"})]})]})})}),r.jsx(m,{children:N&&r.jsx(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"relative z-10 bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 mb-6",children:r.jsxs("div",{className:"flex items-start space-x-3",children:[r.jsx(c,{className:"w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0"}),r.jsxs("div",{children:[r.jsx("h4",{className:"font-medium text-gray-900 dark:text-white mb-1",children:"Performance Tip"}),r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:"cache-hit"===t?"Questions loaded instantly from cache! Future loads will be even faster.":"We're preloading related questions in the background for smoother transitions."})]})]})})}),i&&r.jsxs("div",{className:"relative z-10 flex items-center justify-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-4",children:[r.jsx(l,{className:"w-4 h-4"}),r.jsxs("span",{children:["Estimated time: ",i]})]}),f&&r.jsx("div",{className:"relative z-10 text-center",children:r.jsx("button",{onClick:f,className:"text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors",children:"Cancel Loading"})}),r.jsx("div",{className:"absolute inset-0 pointer-events-none",children:[...Array(6)].map((e,t)=>r.jsx(u.div,{className:"absolute w-2 h-2 bg-blue-400/20 rounded-full",animate:{x:[0,100*Math.random()-50],y:[0,100*Math.random()-50],opacity:[0,1,0],scale:[0,1,0]},transition:{duration:3+2*Math.random(),repeat:1/0,delay:2*Math.random()},style:{left:100*Math.random()+"%",top:100*Math.random()+"%"}},t))})]})});var S},A=({timeLeft:e,formatTime:t,isLowTime:s=!1,progressPercentage:a=100,timerKey:i,initialTime:n=60,showProgressBar:o=!0,size:d="normal"})=>{const x=e/n*100,g=x<=10?"critical":x<=25?"warning":x<=50?"caution":"normal",h=(()=>{const e={container:"relative flex items-center justify-center rounded-xl transition-all duration-300",text:"font-bold tabular-nums",progress:"absolute inset-0 rounded-xl transition-all duration-300"};return{...{small:{container:`${e.container} h-12 w-24 text-sm`,text:`${e.text} text-sm`,icon:"w-3 h-3",progress:e.progress},normal:{container:`${e.container} h-16 w-32 text-lg`,text:`${e.text} text-lg`,icon:"w-4 h-4",progress:e.progress},large:{container:`${e.container} h-20 w-40 text-xl`,text:`${e.text} text-xl`,icon:"w-5 h-5",progress:e.progress}}[d],...{normal:{container:"bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg",progress:"bg-gradient-to-r from-blue-400 to-blue-500",glow:""},caution:{container:"bg-gradient-to-r from-yellow-500 to-orange-500 text-white shadow-lg",progress:"bg-gradient-to-r from-yellow-400 to-orange-400",glow:"shadow-yellow-200"},warning:{container:"bg-gradient-to-r from-orange-500 to-red-500 text-white shadow-lg",progress:"bg-gradient-to-r from-orange-400 to-red-400",glow:"shadow-orange-200 animate-pulse"},critical:{container:"bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg",progress:"bg-gradient-to-r from-red-400 to-red-500",glow:"shadow-red-200 animate-pulse"}}[g]}})();return r.jsxs("div",{className:"flex flex-col items-center space-y-2 mb-6",children:[r.jsxs(u.div,{variants:{normal:{scale:1,rotate:0},caution:{scale:1.02,rotate:0},warning:{scale:1.05,rotate:[-1,1,-1,0]},critical:{scale:1.1,rotate:[-2,2,-2,2,0]}},animate:g,transition:{duration:"critical"===g?.5:"warning"===g?.8:1,repeat:"critical"===g||"warning"===g?1/0:0,repeatType:"reverse"},className:`${h.container} ${h.glow} relative overflow-hidden`,children:[o&&r.jsx("div",{className:`${h.progress} opacity-30`,style:{width:`${Math.max(0,Math.min(100,x))}%`,transition:"width 1s linear"}}),r.jsxs("div",{className:"relative z-10 flex items-center space-x-2",children:[(()=>{switch(g){case"critical":return r.jsx(f,{className:`${h.icon} animate-bounce`});case"warning":return r.jsx(f,{className:`${h.icon} animate-pulse`});case"caution":return r.jsx(c,{className:h.icon});default:return r.jsx(l,{className:h.icon})}})(),r.jsx(u.span,{variants:{normal:{scale:1},caution:{scale:1},warning:{scale:[1,1.1,1]},critical:{scale:[1,1.2,1]}},animate:g,transition:{duration:.3,repeat:"critical"===g?1/0:0,repeatType:"reverse"},className:h.text,children:t?t(e):`${e}s`})]}),r.jsx(m,{children:"critical"===g&&r.jsx(u.div,{initial:{scale:1,opacity:.5},animate:{scale:1.5,opacity:0},exit:{scale:1,opacity:0},transition:{duration:1,repeat:1/0,ease:"easeOut"},className:"absolute inset-0 bg-red-400 rounded-xl"})})]},i),o&&r.jsx("div",{className:"w-full max-w-xs",children:r.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden",children:r.jsx(u.div,{className:"h-full rounded-full transition-all duration-1000 ease-linear "+("critical"===g?"bg-red-500":"warning"===g?"bg-orange-500":"caution"===g?"bg-yellow-500":"bg-blue-500"),style:{width:`${Math.max(0,Math.min(100,x))}%`},animate:{boxShadow:"critical"===g?["0 0 0 rgba(239, 68, 68, 0)","0 0 20px rgba(239, 68, 68, 0.6)","0 0 0 rgba(239, 68, 68, 0)"]:"warning"===g?["0 0 0 rgba(249, 115, 22, 0)","0 0 15px rgba(249, 115, 22, 0.4)","0 0 0 rgba(249, 115, 22, 0)"]:"none"},transition:{boxShadow:{duration:1,repeat:1/0,ease:"easeInOut"}}})})}),r.jsx(m,{children:("warning"===g||"critical"===g)&&r.jsx(u.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"text-center text-xs font-medium px-3 py-1 rounded-full "+("critical"===g?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200":"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200"),children:"critical"===g?"Time almost up!":"Running low on time"})}),r.jsx(m,{children:"normal"===g&&x>75&&r.jsx(u.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},transition:{duration:.3},className:"text-center text-xs font-medium text-green-600 dark:text-green-400",children:"Great pace! Keep it up ðŸš€"})})]})},L=({trigger:t,duration:s=3e3})=>{const[a,i]=e.useState(!1);e.useEffect(()=>{if(t){i(!0);const e=setTimeout(()=>i(!1),s);return()=>clearTimeout(e)}},[t,s]);const n=Array.from({length:50},(e,t)=>({id:t,left:100*Math.random(),delay:2*Math.random(),duration:2+2*Math.random(),color:["bg-red-500","bg-blue-500","bg-green-500","bg-yellow-500","bg-purple-500","bg-pink-500"][Math.floor(6*Math.random())]}));return r.jsx(m,{children:a&&r.jsx("div",{className:"fixed inset-0 pointer-events-none z-50 overflow-hidden",children:n.map(e=>r.jsx(u.div,{className:`absolute w-2 h-2 ${e.color} rounded-sm`,style:{left:`${e.left}%`,top:"-10px"},initial:{y:-20,rotate:0,opacity:1},animate:{y:window.innerHeight+20,rotate:360,opacity:0},transition:{duration:e.duration,delay:e.delay,ease:"easeIn"}},e.id))})})},F=({score:e,questionCount:t,accuracy:s,userAnswers:a,quizSession:i,quizConfig:n,timeSpent:o,onRestart:d,onGoHome:m})=>{const x=s>=80?{grade:"A",color:"text-green-600",bgColor:"bg-green-100",message:"Excellent! USMLE ready!"}:s>=70?{grade:"B",color:"text-blue-600",bgColor:"bg-blue-100",message:"Good job! Keep it up!"}:s>=60?{grade:"C",color:"text-yellow-600",bgColor:"bg-yellow-100",message:"Not bad! More practice needed!"}:{grade:"D",color:"text-red-600",bgColor:"bg-red-100",message:"Keep practicing! You'll improve!"};o&&(Math.floor(o/60),(o%60).toString().padStart(2,"0"));return r.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900/20 dark:to-indigo-900/20",children:[r.jsx(L,{trigger:s>=80,duration:4e3}),r.jsx("div",{className:"container mx-auto px-4 py-8",children:r.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-4xl mx-auto",children:[r.jsxs("div",{className:"text-center mb-8",children:[r.jsx(u.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.2,type:"spring",stiffness:200},className:"inline-flex items-center justify-center w-16 h-16 rounded-full text-white mb-4 "+(s>=80?"bg-gradient-to-r from-yellow-500 to-orange-500":"bg-purple-600"),children:s>=80?r.jsx(b,{className:"w-8 h-8"}):r.jsx(c,{className:"w-8 h-8"})}),r.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2",children:s>=80?"ðŸŽ‰ Outstanding! ðŸŽ‰":"Quick Quiz Complete!"}),r.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:s>=80?"You absolutely crushed it!":x.message}),s>=80&&r.jsx(u.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.8},className:"text-sm text-purple-600 dark:text-purple-400 mt-2",children:"ðŸŒŸ You're ready for the real thing! ðŸŒŸ"})]}),r.jsx(u.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.3},className:`${x.bgColor} rounded-2xl p-4 sm:p-8 mb-8 text-center`,children:r.jsxs("div",{className:"flex flex-col sm:flex-row items-center justify-center sm:space-x-6 space-y-4 sm:space-y-0",children:[r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:`text-4xl sm:text-6xl font-bold ${x.color} mb-1 sm:mb-2`,children:e}),r.jsxs("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:["out of ",t]})]}),r.jsxs("div",{className:"text-center",children:[r.jsxs("div",{className:`text-4xl sm:text-6xl font-bold ${x.color} mb-1 sm:mb-2`,children:[s,"%"]}),r.jsx("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:"accuracy"})]}),r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:`text-4xl sm:text-6xl font-bold ${x.color} mb-1 sm:mb-2`,children:x.grade}),r.jsx("div",{className:"text-sm sm:text-base text-gray-600 dark:text-gray-300",children:"grade"})]})]})}),r.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4},className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[r.jsx(b,{className:"w-8 h-8 text-yellow-500 mx-auto mb-2"}),r.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:e>=8?"Quiz Master!":e>=6?"Good Work!":"Keep Going!"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[r.jsx(w,{className:"w-8 h-8 text-blue-500 mx-auto mb-2"}),r.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:s>=80?"Sharpshooter":s>=60?"On Target":"Practice Makes Perfect"})]}),r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-4 text-center",children:[r.jsx(l,{className:"w-8 h-8 text-green-500 mx-auto mb-2"}),r.jsx("div",{className:"font-semibold text-gray-900 dark:text-white",children:"Quick & Focused"})]})]}),r.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"bg-white dark:bg-gray-800 rounded-2xl p-4 sm:p-6 mb-8",children:[r.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-6",children:"Detailed Review"}),r.jsx("div",{className:"space-y-6",children:a.map((e,t)=>r.jsx(u.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.6+.1*t},className:"border border-gray-200 dark:border-gray-700 rounded-xl p-4 sm:p-6",children:r.jsxs("div",{className:"flex items-start space-x-4",children:[r.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center "+(e.isCorrect?"bg-green-100 dark:bg-green-900/30":e.timedOut?"bg-orange-100 dark:bg-orange-900/30":"bg-red-100 dark:bg-red-900/30"),children:e.isCorrect?r.jsx(y,{className:"w-5 h-5 text-green-600"}):e.timedOut?r.jsx(l,{className:"w-5 h-5 text-orange-600"}):r.jsx(j,{className:"w-5 h-5 text-red-600"})}),r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center justify-between mb-3",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:["Question ",t+1]}),e.timedOut&&r.jsx("span",{className:"text-sm font-medium text-orange-600 dark:text-orange-400",children:"Time ran out"})]}),r.jsx("p",{className:"text-gray-700 dark:text-gray-300 mb-4",children:e.question.question_text}),r.jsx("div",{className:"space-y-2 mb-4",children:e.question.options.map(t=>{const s=t.id===e.selectedOptionId,a=t.id===e.question.correct_option_id;return r.jsx("div",{className:"p-3 rounded-lg border-2 "+(s&&a?"border-green-500 bg-green-50 dark:bg-green-900/20":s&&!a?"border-red-500 bg-red-50 dark:bg-red-900/20":a?"border-green-300 bg-green-50 dark:bg-green-900/10":"border-gray-200 dark:border-gray-600"),children:r.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-1 sm:space-y-0",children:[r.jsx("span",{className:"text-gray-900 dark:text-white",children:t.text}),r.jsxs("div",{className:"flex space-x-2",children:[s&&r.jsx("span",{className:"text-xs sm:text-sm font-medium text-blue-600",children:"Your Answer"}),a&&r.jsx("span",{className:"text-xs sm:text-sm font-medium text-green-600",children:"Correct"})]})]})},t.id)})}),e.question.explanation&&r.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[r.jsx("h4",{className:"font-semibold text-blue-900 dark:text-blue-100 mb-2",children:"Explanation"}),r.jsx("p",{className:"text-blue-800 dark:text-blue-200",children:e.question.explanation})]})]})]})},t))})]}),r.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},className:"flex flex-col sm:flex-row gap-4 justify-center",children:[r.jsxs("button",{onClick:d,className:"flex items-center justify-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:[r.jsx(v,{className:"w-5 h-5"}),r.jsx("span",{children:"Try Again"})]}),r.jsx("button",{onClick:m,className:"flex items-center justify-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:r.jsx("span",{children:"Back to Home"})}),s>=80&&r.jsxs("button",{onClick:()=>{const a=`Just scored ${e}/${t} (${s}%) on a USMLE ${n?.quizMode||"Quick"} Quiz! ðŸŽ‰`;navigator.share?navigator.share({title:"USMLE Quiz Results",text:a,url:window.location.origin}):(navigator.clipboard.writeText(`${a} Check it out at ${window.location.origin}`),alert("Results copied to clipboard!"))},className:"flex items-center justify-center space-x-2 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold py-3 px-6 rounded-xl transition-colors",children:[r.jsx(N,{className:"w-5 h-5"}),r.jsx("span",{children:"Share Success!"})]})]})]})})]})},P=()=>{const i=a(),n=q(),o=k(),{user:l}=S(),c=e.useMemo(()=>{const e=n.state||{},t=E.getQuizModeConfig(e.quizMode||"quick");return{categoryId:o.categoryId||e.categoryId||"mixed",questionCount:e.questionCount||t.questionCount,difficulty:e.difficulty||null,quizMode:e.quizMode||"quick",quizType:e.quizType||"quick",autoAdvance:void 0!==e.autoAdvance?e.autoAdvance:t.autoAdvance,timePerQuestion:e.timePerQuestion||t.timePerQuestion,showExplanations:e.showExplanations||t.showExplanations}},[n.state,o.categoryId]),{categoryId:d,questionCount:x,difficulty:g,quizMode:h,quizType:p,autoAdvance:y,timePerQuestion:f,showExplanations:b}=c,{getOfflineData:w}=z(),{data:j=[],isLoading:v,error:N,refetch:_}=useQuery({queryKey:["questions",d,x,g],queryFn:()=>E.getQuestionsForQuiz({categoryId:d,questionCount:x,difficulty:g,quizMode:h}),staleTime:3e5,cacheTime:6e5,retry:2,refetchOnWindowFocus:!1});(()=>{const[t,s]=e.useState({averageLoadTime:0,cacheHitRatio:0,totalQuestions:0,imageLoadSuccessRate:0}),a=e.useCallback(()=>{const e=T.getCacheStats();s(t=>({...t,cacheHitRatio:e.cacheHitRatio,totalQuestionsLoaded:e.questionCacheSize}))},[]);e.useEffect(()=>{const e=setInterval(a,5e3);return()=>clearInterval(e)},[a])})();const L=e.useMemo(()=>N&&j.length>0,[N,j.length]),{currentQuestionIndex:P,currentQuestion:R,selectedOption:U,score:D,userAnswers:H,quizCompleted:K,showResults:G,progress:B,accuracy:W,handleOptionSelect:Y,handleTimeout:J,advanceQuestion:V,resetQuiz:X}=((t=[],s=10)=>{const[a,r]=e.useState(0),[i,n]=e.useState(null),[o,l]=e.useState(0),[c,d]=e.useState([]),[u,m]=e.useState(!1),[x,g]=e.useState(!1),[h,p]=e.useState(!1),y=t[a]||null,f=(a+1)/s*100,b=c.length>0?Math.round(o/c.length*100):0,w=e.useCallback(e=>{if(null!==i||h||!y)return;n(e);const t=e===y.correct_option_id;t&&l(e=>e+1);const s={questionIndex:a,question:y,selectedOptionId:e,isCorrect:t,timedOut:!1};return d(e=>[...e,s]),{isCorrect:t,userAnswer:s}},[i,h,y,a]),j=e.useCallback(()=>{if(null!==i||h||!y)return;const e={questionIndex:a,question:y,selectedOptionId:null,isCorrect:!1,timedOut:!0};return d(t=>[...t,e]),{isCorrect:!1,userAnswer:e}},[i,h,y,a]),v=e.useCallback(()=>{p(!0),setTimeout(()=>{a<t.length-1?(r(e=>e+1),n(null),p(!1)):N()},500)},[a,t.length]),N=e.useCallback(()=>{m(!0);let e=[...c];if(null!==i&&!c.find(e=>e.questionIndex===a)){const t=i===y?.correct_option_id;e.push({questionIndex:a,question:y,selectedOptionId:i,isCorrect:t,timedOut:!1})}const t=e.filter(e=>e.isCorrect).length;return l(t),d(e),g(!0),{finalScore:t,allAnswers:e}},[c,i,a,y]),q=e.useCallback(()=>{r(0),n(null),l(0),d([]),m(!1),g(!1),p(!1)},[]);return{currentQuestionIndex:a,currentQuestion:y,selectedOption:i,score:o,userAnswers:c,quizCompleted:u,showResults:x,isAutoAdvancing:h,progress:f,accuracy:b,canAdvance:null!==i||h,handleOptionSelect:w,handleTimeout:j,advanceQuestion:v,completeQuiz:N,resetQuiz:q}})(j,x),{session:Z,recordResponse:ee,resetSession:te}=((a,r,i=!1)=>{const[n,o]=e.useState(null),[l,c]=e.useState([]),[d,u]=e.useState(null),m=t();new M(a?.id);const x=s({mutationFn:async e=>i?null:E.createQuizSession({userId:a.id,quizMode:e.quizMode,categoryId:e.categoryId,questionCount:e.questionCount,difficulty:e.difficulty,timerConfig:{timePerQuestion:e.timePerQuestion,totalTime:e.totalTime},settings:e}),onSuccess:e=>{o(e),u(Date.now())},onError:e=>{console.error("Enhanced session creation failed:",e)}}),g=s({mutationFn:async({sessionId:e,responses:t})=>{if(!i)return E.recordQuizResponses(e,t)}}),h=s({mutationFn:async({sessionId:e,completionData:t})=>{if(!i)return l.length>0&&await E.recordQuizResponses(e,l),E.completeQuizSession(e,t)},onSuccess:()=>{m.invalidateQueries(["user-stats",a?.id]),m.invalidateQueries(["quiz-history",a?.id])}}),p=e.useCallback(async()=>{if(!a||n||i)return null;try{return await x.mutateAsync(r)}catch(e){return console.error("Failed to create enhanced quiz session:",e),null}},[a,n,i,x,r]),y=e.useCallback(e=>{const t={questionId:e.questionId,selectedOptionId:e.selectedOptionId,isCorrect:e.isCorrect,timeSpent:e.timeSpent||0,answeredAt:(new Date).toISOString()};c(e=>[...e,t])},[]),f=e.useCallback(async e=>{if(!n||i)return;const t=d?Math.floor((Date.now()-d)/1e3):0,s={correctAnswers:e.score,totalTimeSeconds:t,pointsEarned:10*e.score,userId:a.id};try{return await h.mutateAsync({sessionId:n.id,completionData:s}),o(null),c([]),u(null),{success:!0}}catch(r){return console.error("Failed to complete enhanced quiz session:",r),{success:!1,error:r}}},[n,i,d,a,h]),b=e.useCallback(()=>{o(null),c([]),u(null)},[]);return e.useEffect(()=>{a&&!n&&!i&&r&&p()},[a,n,i,r,p]),{session:n,responses:l,startTime:d,createSession:p,recordResponse:y,completeSession:f,resetSession:b,isCreating:x.isLoading,isRecording:g.isLoading,isCompleting:h.isLoading,createError:x.error,recordError:g.error,completeError:h.error}})(l,c,L),{timeLeft:se,timerKey:ae,formatTime:re,resetTimer:ie,isLowTime:ne,progressPercentage:oe}=(({initialTime:t=60,isActive:s=!0,onTimeUp:a,resetTrigger:r=0})=>{const[i,n]=e.useState(t),[o,l]=e.useState(0);e.useEffect(()=>{n(t),l(e=>e+1)},[r,t]),e.useEffect(()=>{if(!s)return;const e=setInterval(()=>{n(e=>e<=1?(a?.(),t):e-1)},1e3);return()=>clearInterval(e)},[s,a,t,o]);const c=e.useCallback(()=>{n(t),l(e=>e+1)},[t]),d=e.useCallback(()=>`${Math.floor(i/60)}:${(i%60).toString().padStart(2,"0")}`,[i]);return{timeLeft:i,timerKey:o,formatTime:d,resetTimer:c,isLowTime:i<=10,progressPercentage:i/t*100}})({initialTime:60,isActive:!G&&!K&&!!R,onTimeUp:()=>{J()&&ee({questionId:R.id,selectedOptionId:null,isCorrect:!1,responseOrder:P+1,timeSpent:60}),V()},resetTrigger:P});e.useEffect(()=>{l&&j.length>0&&!Z&&createSession()},[l,j.length,Z,createSession]);const le=()=>{X(),te(),ie()},ce=()=>{i("/")};return v?r.jsx($,{preloadStatus:preloadStatus,cacheStats:cacheStats,isPreloading:isPreloading,estimatedTime:performanceMetrics?.loadTime?`${Math.round(performanceMetrics.loadTime/1e3)}s`:null,loadingStage:"questions",showDetailedProgress:!0}):N&&0===j.length?r.jsx(C,{error:N,onRetry:()=>window.location.reload(),categoryId:d,questionCount:x,getOfflineData:w,showOfflineOption:!0}):(v||N||0!==j.length||console.log("No questions loaded, this might indicate a data issue"),G?r.jsx(F,{score:D,questionCount:x,accuracy:W,userAnswers:H,quizSession:Z,quizConfig:c,timeSpent:H.reduce((e,t)=>e+(t.timeSpent||0),0),onRestart:le,onGoHome:ce}):r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 dark:from-gray-900 dark:via-purple-900/20 dark:to-indigo-900/20",children:r.jsx("div",{className:"container mx-auto px-4 py-8",children:r.jsxs("div",{className:"max-w-4xl mx-auto",children:[r.jsx(A,{timeLeft:se,formatTime:re,isLowTime:ne,progressPercentage:oe,timerKey:ae}),r.jsx(O,{categoryName:c.categoryName||d,currentQuestionIndex:P,totalQuestions:x,score:D,isOffline:L,isFetching:v,timeLeft:se,isTimed:"timed"===c.quizMode,quizMode:c.quizMode,quizType:c.quizType}),r.jsx(I,{current:P+1,total:x,progress:B,score:D,accuracy:W,averageTime:H.length>0?H.reduce((e,t)=>e+(t.timeSpent||0),0)/H.length:0,showDetailed:!0,size:"normal"}),r.jsx(m,{mode:"wait",children:r.jsx(u.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},children:R&&r.jsx(Q,{currentQuestion:R,selectedOption:U,isAnswered:null!==U,handleOptionSelect:e=>{const t=Y(e);t&&(ee({questionId:R.id,selectedOptionId:e,isCorrect:t.isCorrect,responseOrder:P+1,timeSpent:60-se}),setTimeout(()=>{V()},500))},showExplanations:!0,questionNumber:P+1,totalQuestions:x,timeSpent:60-se,difficulty:g||"medium"})},P)})]})})}))};export{P as default};
