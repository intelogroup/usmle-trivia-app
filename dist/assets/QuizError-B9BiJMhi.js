import{l as e,b as s,s as t,i as r}from"./index-DxK6xHzU.js";import{j as a,y as i,z as n,av as o,m as c,l as d,aV as l,aW as u,u as g,T as m,R as x,aw as h,H as p,D as f,ay as y,aX as w}from"./vendor-CNKhjeNv.js";function b(e){let s,t=e.length;for(;t>0;)s=Math.floor(Math.random()*t),t--,[e[t],e[s]]=[e[s],e[t]];return e}async function N({categoryId:e="mixed",questionCount:s=10,difficulty:r=null}){const a=performance.now();try{let i;i=e&&"mixed"!==e?t.from("questions").select("\n          id,\n          question_text,\n          options,\n          correct_option_id,\n          explanation,\n          difficulty,\n          points,\n          image_url,\n          is_active,\n          usage_count,\n          average_time_seconds,\n          created_at,\n          updated_at,\n          category_id,\n          correct_count,\n          source,\n          created_by,\n          reviewed_by,\n          reviewed_at,\n          question_tags!inner(tag_id)\n        ").eq("is_active",!0).eq("question_tags.tag_id",e):t.from("questions").select("*").eq("is_active",!0),r&&(i=i.eq("difficulty",r)),i=i.limit(2*s);const{data:n,error:o}=await i,c=performance.now()-a;if(o)throw console.error("❌ [QuizService] Error fetching questions:",{message:o.message,details:o.details,categoryId:e,questionCount:s,difficulty:r,duration:`${c.toFixed(2)}ms`}),new Error(`FETCH_QUESTIONS_ERROR: ${o.message}`);if(!n||0===n.length)return console.warn("⚠️ [QuizService] No questions found for criteria:",{categoryId:e,questionCount:s,difficulty:r}),[];const d=b([...n]).slice(0,s);return console.log("✅ [QuizService] Successfully fetched questions:",{totalFound:n.length,selected:d.length,categoryId:e,difficulty:r,duration:`${c.toFixed(2)}ms`}),d}catch(i){const t=performance.now()-a;throw console.error("💥 [QuizService] Exception in fetchQuestions:",{error:i.message,categoryId:e,questionCount:s,difficulty:r,duration:`${t.toFixed(2)}ms`}),new Error(`FETCH_QUESTIONS_ERROR: ${i.message}`)}}async function q({userId:r,categoryId:a="mixed",questionCount:i=10,difficulty:n=null}){return e.setContext({userId:r,operation:"fetchQuestionsForUser"}),r?(e.info("Starting smart question fetch for user (using RPC)",{userId:r,categoryId:a,questionCount:i,difficulty:n}),await s("fetchQuestionsForUser",async()=>{try{const{data:s,error:o}=await t.rpc("get_unseen_questions",{p_user_id:r,p_category_id:"mixed"===a?null:a,p_difficulty:n,p_limit:2*i});if(o)return e.error("Error fetching unseen questions via RPC",{error:o}),e.warn("Falling back to basic fetch due to RPC error",{error:o.message}),console.error("[RPC ERROR] get_unseen_questions:",o),N({categoryId:a,questionCount:i,difficulty:n});if(!s||0===s.length)return e.warn("No unseen questions found, falling back to basic fetch"),N({categoryId:a,questionCount:i,difficulty:n});const c=b([...s]).slice(0,i);return e.success("Successfully fetched smart questions for user",{totalUnseen:s.length,selected:c.length,categoryId:a,difficulty:n}),c}catch(s){return e.error("Exception in fetchQuestionsForUser, falling back to basic fetch",{error:s.message,stack:s.stack}),N({categoryId:a,questionCount:i,difficulty:n})}})):(e.warn("No userId provided, falling back to basic fetchQuestions",{categoryId:a,questionCount:i,difficulty:n}),N({categoryId:a,questionCount:i,difficulty:n}))}const _={quick:"quick",timed:"timed",custom:"self_paced",block:"block",self_paced:"self_paced",learn_module:"learn_module"};async function j(s){const{userId:r,sessionType:a="self_paced",totalQuestions:i,categoryName:n=null,timePerQuestion:o=null,autoAdvance:c=!1,showExplanations:d=!0,settings:l={}}=s;if(!r)throw e.error("Cannot create quiz session: userId is required"),new Error("User ID is required to create a quiz session");if(!i||i<=0)throw e.error("Cannot create quiz session: totalQuestions must be positive"),new Error("Total questions must be a positive number");try{const{data:{user:s},error:a}=await t.auth.getUser();if(a||!s||s.id!==r)throw e.error("Authentication verification failed",{authError:a,currentUserId:s?.id,requestedUserId:r}),new Error("Authentication required to create quiz session")}catch(x){throw e.error("Failed to verify authentication",{error:x.message,userId:r}),new Error("Please log in to create a quiz session")}e.info("Creating quiz session",{userId:r,sessionType:a,totalQuestions:i,categoryName:n,timePerQuestion:o,autoAdvance:c,showExplanations:d});const u=_[a]||"self_paced",g={user_id:r,session_type:u,total_questions:i,started_at:(new Date).toISOString(),category_name:n,settings:{timePerQuestion:o,autoAdvance:c,showExplanations:d,...l}},{data:m,error:x}=await t.from("quiz_sessions").insert(g).select().single();if(x)throw e.error("Database error creating quiz session",{error:x.message,code:x.code,details:x.details,hint:x.hint,sessionData:g}),new Error(`CREATE_SESSION_ERROR: ${x.message}`);return e.success("Quiz session created successfully",{sessionId:m.id,sessionType:u,totalQuestions:i}),m}async function I(s,a){const{correctAnswers:i,totalTimeSeconds:n,pointsEarned:o=0,completed:c=!0}=a;e.info("Completing quiz session",{sessionId:s,correctAnswers:i,totalTimeSeconds:n,pointsEarned:o,completed:c});const d={correct_answers:i,completed_at:(new Date).toISOString(),total_time_seconds:n,points_earned:o,is_completed:c},{data:l,error:u}=await t.from("quiz_sessions").update(d).eq("id",s).select().single();if(u)throw e.error("Error completing quiz session",{error:u,sessionId:s,updateData:d}),new Error(`COMPLETE_SESSION_ERROR: ${u.message}`);e.success("Quiz session completed successfully",{sessionId:l.id,correctAnswers:i,totalTimeSeconds:n,pointsEarned:o});try{const s=l.user_id;s&&(r.userData(s),e.info("Invalidated user data queries for immediate UI update",{userId:s}))}catch(u){e.warn("Failed to invalidate queries after quiz completion",{error:u.message})}return l}async function E(s){const{sessionId:r,questionId:a,selectedOptionId:i,isCorrect:n,timeSpent:o,responseOrder:c,userId:d}=s;if(!r)throw e.error("Cannot record quiz response: sessionId is required"),new Error("Session ID is required to record quiz response");if(!a)throw e.error("Cannot record quiz response: questionId is required"),new Error("Question ID is required to record quiz response");try{const{data:{user:s},error:i}=await t.auth.getUser();if(i||!s)throw e.error("Authentication verification failed during response recording",{authError:i,currentUserId:s?.id,sessionId:r,questionId:a}),new Error("Authentication required to record quiz response")}catch(l){throw e.error("Failed to verify authentication for response recording",{error:l.message,sessionId:r,questionId:a}),new Error("Please log in to record quiz responses")}e.info("Recording quiz response",{sessionId:r,questionId:a,selectedOptionId:i,isCorrect:n,timeSpent:o,responseOrder:c,userId:d});try{const{data:u,error:g}=await t.from("quiz_responses").insert({session_id:r,question_id:a,selected_option_id:i,is_correct:n,time_spent_seconds:o,response_order:c}).select().single();if(g)throw e.error("Error recording quiz response",{error:g,responseData:s}),new Error(`RECORD_RESPONSE_ERROR: ${g.message}`);return d&&a&&async function({userId:s,questionId:r,answeredCorrectly:a}){e.info("Recording question interaction via RPC",{userId:s,questionId:r,answeredCorrectly:a});try{const{data:i,error:n}=await t.rpc("record_question_interaction",{p_user_id:s,p_question_id:r,p_answered_correctly:a});if(n)throw e.error("Error recording question interaction via RPC",{error:n,userId:s,questionId:r,answeredCorrectly:a}),new Error(`RECORD_INTERACTION_ERROR: ${n.message}`);return e.success("Question interaction recorded successfully",{userId:s,questionId:r,answeredCorrectly:a,result:i}),i}catch(l){throw e.error("Exception in recordQuestionInteraction",{error:l.message,userId:s,questionId:r,answeredCorrectly:a}),l}}({userId:d,questionId:a,answeredCorrectly:n}).catch(s=>{e.warn("Failed to update user question history (non-critical)",{error:s.message,userId:d,questionId:a,isCorrect:n})}),e.success("Quiz response recorded successfully",{responseId:u.id,questionId:a,isCorrect:n,timeSpent:o}),u}catch(l){throw e.error("Exception in recordQuizResponse",{error:l.message,stack:l.stack,responseData:s}),l}}const R=({current:e,total:s,progress:t,score:r=0,accuracy:u=0,averageTime:g=0,showDetailed:m=!0,size:x="normal"})=>{const h=Math.max(0,Math.min(100,e/s*100)),p=Math.max(0,Math.min(100,u)),f=s-e,y=()=>p>=80?"text-green-600 dark:text-green-400":p>=60?"text-blue-600 dark:text-blue-400":p>=40?"text-yellow-600 dark:text-yellow-400":"text-red-600 dark:text-red-400",w=(()=>{switch(x){case"compact":return{container:"py-2",progressHeight:"h-2",text:"text-sm",icons:"w-4 h-4",spacing:"space-y-1"};case"detailed":return{container:"py-6",progressHeight:"h-4",text:"text-base",icons:"w-5 h-5",spacing:"space-y-4"};default:return{container:"py-4",progressHeight:"h-3",text:"text-sm",icons:"w-4 h-4",spacing:"space-y-2"}}})();return a.jsxs("div",{className:`bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 ${w.container}`,children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{className:"flex items-center space-x-3",children:[a.jsx("h3",{className:`font-semibold text-gray-900 dark:text-white ${w.text}`,children:"Progress"}),a.jsxs("span",{className:`font-bold ${w.text} text-blue-600 dark:text-blue-400`,children:[e," / ",s]})]}),m&&a.jsxs("div",{className:"flex items-center space-x-4 text-sm",children:[a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(i,{className:"w-4 h-4 text-purple-500"}),a.jsxs("span",{className:"font-medium text-gray-700 dark:text-gray-300",children:["Score: ",a.jsx("span",{className:"text-purple-600 dark:text-purple-400",children:r})]})]}),u>0&&a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(n,{className:"w-4 h-4 text-green-500"}),a.jsxs("span",{className:"font-medium text-gray-700 dark:text-gray-300",children:["Accuracy: ",a.jsxs("span",{className:y(),children:[Math.round(p),"%"]})]})]}),g>0&&a.jsxs("div",{className:"flex items-center space-x-1",children:[a.jsx(o,{className:"w-4 h-4 text-orange-500"}),a.jsxs("span",{className:"font-medium text-gray-700 dark:text-gray-300",children:["Avg: ",a.jsxs("span",{className:"text-orange-600 dark:text-orange-400",children:[Math.round(g),"s"]})]})]})]})]}),a.jsxs("div",{className:`relative bg-gray-200 dark:bg-gray-700 rounded-full ${w.progressHeight} overflow-hidden mb-4`,children:[a.jsxs(c.div,{className:`${w.progressHeight} bg-gradient-to-r ${p>=80?"from-green-500 to-emerald-600":p>=60?"from-blue-500 to-blue-600":p>=40?"from-yellow-500 to-orange-500":"from-orange-500 to-red-500"} rounded-full relative`,initial:{width:0},animate:{width:`${h}%`},transition:{duration:.8,ease:"easeOut"},children:[a.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-pulse"}),h>15&&a.jsx("div",{className:"absolute inset-0 flex items-center justify-end pr-2",children:a.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-sm",children:[Math.round(h),"%"]})})]}),a.jsx(c.div,{className:"absolute top-0 h-full w-1 bg-white shadow-lg",initial:{left:0},animate:{left:`${h}%`},transition:{duration:.8,ease:"easeOut"},style:{transform:"translateX(-50%)"}})]}),s<=20&&"compact"!==x&&a.jsx("div",{className:"mb-4",children:a.jsx("div",{className:"flex items-center justify-center space-x-2 flex-wrap gap-1 pb-6",children:Array.from({length:s},(s,t)=>{const r=t+1,i=r<e,n=r===e;return a.jsxs(c.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.05*t,duration:.3},className:"relative",children:[i?a.jsx(c.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.1},className:"flex items-center justify-center",children:a.jsx(d,{className:`${w.icons} text-green-500`})}):n?a.jsx(c.div,{animate:{scale:[1,1.2,1],rotate:[0,180,360]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},className:"flex items-center justify-center",children:a.jsx(l,{className:`${w.icons} text-blue-500 fill-current`})}):a.jsx(l,{className:`${w.icons} text-gray-300 dark:text-gray-600`}),a.jsx("div",{className:"absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs text-gray-500 dark:text-gray-400",children:r})]},t)})})}),m&&"detailed"===x&&a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-center",children:[a.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3",children:[a.jsx("div",{className:"text-lg font-bold text-blue-600 dark:text-blue-400",children:f}),a.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Remaining"})]}),a.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-3",children:[a.jsx("div",{className:"text-lg font-bold text-green-600 dark:text-green-400",children:r}),a.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Correct"})]}),a.jsxs("div",{className:"bg-purple-50 dark:bg-purple-900/20 rounded-lg p-3",children:[a.jsxs("div",{className:`text-lg font-bold ${y()}`,children:[Math.round(p),"%"]}),a.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Accuracy"})]}),a.jsxs("div",{className:"bg-orange-50 dark:bg-orange-900/20 rounded-lg p-3",children:[a.jsx("div",{className:"text-lg font-bold text-orange-600 dark:text-orange-400",children:g>0?`${Math.round(g)}s`:"--"}),a.jsx("div",{className:"text-xs text-gray-600 dark:text-gray-400",children:"Avg Time"})]})]}),m&&"compact"!==x&&a.jsx("div",{className:"mt-4 text-center",children:a.jsx(c.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"text-sm text-gray-600 dark:text-gray-400",children:h>=75?a.jsx("span",{className:"text-green-600 dark:text-green-400 font-medium",children:"🎉 Almost there! You're doing great!"}):h>=50?a.jsx("span",{className:"text-blue-600 dark:text-blue-400 font-medium",children:"🚀 Halfway done! Keep up the momentum!"}):h>=25?a.jsx("span",{className:"text-purple-600 dark:text-purple-400 font-medium",children:"💪 Good progress! Stay focused!"}):a.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"🌟 Just getting started! You've got this!"})})})]})},v=({isFetching:e})=>a.jsxs("div",{className:"flex flex-col justify-center items-center h-screen",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"}),a.jsx("p",{className:"text-gray-600",children:"Loading quiz questions..."}),e&&a.jsxs("p",{className:"text-sm text-gray-500",children:["Fetching latest questions ",a.jsx(u,{size:16,className:"inline-block animate-pulse"})]})]}),k=e=>e?"NO_QUESTIONS"===e.code?e.message||"No questions found for your selected category or difficulty.":"NO_CONFIG"===e.code?"Quiz configuration is missing. Please try starting the quiz again.":"FETCH_ERROR"===e.code?e.message||"Failed to load questions from the database.":e.message?.includes("FETCH_QUESTIONS_ERROR")?"Failed to fetch quiz questions. Please try again or adjust your filters.":e.message?.includes("SESSION_CREATION_ERROR")?"Failed to create a quiz session. Please try starting the quiz again.":e.message?.includes("RESPONSE_RECORDING_ERROR")?"Failed to record your response. Please continue to the next question.":e.message?.includes("SESSION_COMPLETION_ERROR")?"Failed to complete the quiz session. Your progress may not be saved.":"ERR_NETWORK"===e.code||e.message?.toLowerCase().includes("network")?"Network error: Please check your internet connection and try again.":"ERR_SERVER"===e.code||500===e.status?"Server error: Please try again later.":406===e.status?"Not Acceptable: The server could not process your request. Please contact support if this persists.":401===e.status||403===e.status?"You are not authorized to access this quiz. Please log in or check your permissions.":e.message||"There was a problem loading the quiz questions.":"There was a problem loading the quiz questions.",C=({error:e,onRetry:s,categoryId:t,questionCount:r,getOfflineData:i,showOfflineOption:n=!0})=>{const o=g(),c=n?i?.(t,r):null,d=(e=>"NO_QUESTIONS"===e.code?f:"NO_CONFIG"===e.code?y:"FETCH_ERROR"===e.code?m:w)(e),l=((e,s,t)=>{const r=[];return"NO_QUESTIONS"===e.code?(r.push("Try selecting a different difficulty level"),r.push("Choose a different category"),r.push("Use mixed categories for more options"),t>10&&r.push(`Try with fewer questions (${Math.max(5,t-5)})`)):"FETCH_ERROR"===e.code||e.message?.includes("FETCH_QUESTIONS_ERROR")?(r.push("Check your internet connection"),r.push("Try again in a few moments"),r.push("Contact support if the problem persists")):"NO_CONFIG"===e.code||e.message?.includes("SESSION_CREATION_ERROR")?(r.push("Go back to quiz selection"),r.push("Try starting the quiz again")):e.message?.includes("RESPONSE_RECORDING_ERROR")||e.message?.includes("SESSION_COMPLETION_ERROR")?(r.push("Continue with the quiz if possible"),r.push("Your progress may not be saved"),r.push("Contact support if issues persist")):(r.push("Try refreshing the page"),r.push("Check your internet connection"),r.push("Go back to quiz selection")),r})(e,0,r);return a.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl p-8 shadow-lg border border-gray-200 dark:border-gray-700 max-w-lg w-full text-center",children:[a.jsx("div",{className:"p-3 bg-red-100 dark:bg-red-900/30 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center",children:a.jsx(d,{className:"w-8 h-8 text-red-600"})}),a.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-2",children:"Unable to Load Quiz"}),a.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-4",children:k(e)}),e&&(e.code||e.details)&&a.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6 text-left",children:[a.jsxs("h4",{className:"font-medium text-yellow-800 dark:text-yellow-200 mb-2 flex items-center",children:[a.jsx(m,{className:"w-4 h-4 mr-2"}),"What went wrong:"]}),a.jsx("ul",{className:"text-sm text-yellow-700 dark:text-yellow-300 space-y-1",children:l.map((e,s)=>a.jsxs("li",{className:"flex items-start",children:[a.jsx("span",{className:"text-yellow-500 mr-2",children:"•"}),e]},s))})]}),a.jsxs("div",{className:"space-y-3",children:[s&&a.jsxs("button",{onClick:s,className:"w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center space-x-2",children:[a.jsx(x,{className:"w-4 h-4"}),a.jsx("span",{children:"Try Again"})]}),c&&c.length>0&&a.jsxs("button",{onClick:()=>window.location.reload(),className:"w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors duration-200 flex items-center justify-center space-x-2",children:[a.jsx(h,{className:"w-4 h-4"}),a.jsxs("span",{children:["Use Offline Questions (",c.length,")"]})]}),a.jsxs("button",{onClick:()=>{o("/quick-quiz",{state:{categoryId:"mixed",categoryName:"Mixed Categories",questionCount:Math.min(r||10,10),quizType:"quick"}})},className:"w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors duration-200 flex items-center justify-center space-x-2",children:[a.jsx(h,{className:"w-4 h-4"}),a.jsx("span",{children:"Try Mixed Quiz"})]}),a.jsx("button",{onClick:()=>o("/quiz"),className:"w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors duration-200",children:"Back to Categories"}),a.jsxs("button",{onClick:()=>o("/"),className:"w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 flex items-center justify-center space-x-2",children:[a.jsx(p,{className:"w-4 h-4"}),a.jsx("span",{children:"Go Home"})]})]}),!1]})})};export{v as Q,I as a,C as b,j as c,R as d,q as f,E as r};
