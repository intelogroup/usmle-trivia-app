import{s as e,t,v as s,b as r,u as n,r as a,j as i,W as o,w as l,x as c}from"./vendor-react-DID6TU-8.js";import{c as d,q as u,u as g}from"./index-McxExe4l.js";import{QuestionService as x}from"./questionService-DP9FOlo5.js";import{q as m}from"./vendor-CCC68rl8.js";const h="usmle_quiz_cache_",y=(e,t)=>{try{const s={data:t,timestamp:Date.now(),expiry:Date.now()+864e5};localStorage.setItem(h+e,JSON.stringify(s))}catch(s){console.warn("Failed to cache data locally:",s)}},b=e=>{try{const t=localStorage.getItem(h+e);if(!t)return null;const s=JSON.parse(t);return Date.now()>s.expiry?(localStorage.removeItem(h+e),null):s.data}catch(t){return console.warn("Failed to retrieve cached data:",t),null}},f=e=>{try{Object.keys(localStorage).forEach(t=>{t.startsWith(h+(e||""))&&localStorage.removeItem(t)})}catch(t){console.warn("Failed to clear cache:",t)}};function p(){const e=t();return{clearCache:t=>{f(t),t?e.removeQueries({queryKey:[t]}):e.clear()},getCacheSize:()=>{try{let e=0;for(let t in localStorage)t.startsWith(h)&&(e+=localStorage[t].length);return e}catch{return 0}},getOfflineData:(e,t)=>b(`questions_${e}_${t}`)}}const j=()=>{const h=r(),f=n(),{user:j}=g(),{categoryId:N,categoryName:v,questionCount:w}=h.state||{categoryId:null,categoryName:null,questionCount:10},[q,I]=a.useState(0),[k,S]=a.useState(null),[C,_]=a.useState(!1),[Q,z]=a.useState(0),[O,F]=a.useState(null),{data:E=[],isLoading:$,error:D,isError:K,isFetching:P}=function(t,s=10,r={}){const n=`questions_${t}_${s}`;return e({queryKey:u.questionsByCategory(t,s),queryFn:async()=>{try{const e=await x.fetchQuestions(t,s);return y(n,e),e}catch(e){const t=b(n);if(t)return console.info("Using cached questions due to network error"),t;throw e}},staleTime:3e5,gcTime:18e5,refetchOnWindowFocus:!1,...r})}(N,w,{enabled:!!j&&!!N,retry:(e,t)=>{const{getOfflineData:s}=p();return!s(N,w)&&e<2}}),U=function(){const e=t();return s({mutationFn:({userId:e,categoryId:t,questionCount:s})=>x.createQuizSession(e,t,s),onSuccess:(t,s)=>{e.setQueryData(u.quizSessions(s.userId),e=>[...e||[],t])}})}(),A=s({mutationFn:({sessionId:e,questionId:t,selectedOptionId:s,isCorrect:r,responseOrder:n})=>x.recordQuizResponse(e,t,s,r,n)}),W=function(){const e=t();return s({mutationFn:({userId:e,questionId:t,selectedOptionId:s,isCorrect:r})=>x.updateUserQuestionHistory(e,t,s,r),onSuccess:(t,s)=>{e.invalidateQueries({queryKey:u.userProgress(s.userId)})}})}(),L=function(){const e=t();return s({mutationFn:({sessionId:e,userId:t,finalScore:s})=>x.completeQuizSession(e,t,s),onSuccess:(t,s)=>{e.invalidateQueries({queryKey:u.userStats(s.userId)}),e.invalidateQueries({queryKey:u.userProgress(s.userId)})}})}(),{prefetchCategory:T}=function(){t();const e=async(e,t=10)=>d.prefetchQuestions(e,t);return{prefetchCategory:e,prefetchPopularCategories:async t=>{const s=t.sort((e,t)=>(t.question_count||0)-(e.question_count||0)).slice(0,5);return Promise.all(s.map(t=>e(t.id,15)))}}}(),{getOfflineData:B}=p(),J=K&&E.length>0;a.useEffect(()=>{(async()=>{if(j&&N&&E.length>0&&!O)try{const e=await U.mutateAsync({userId:j.id,categoryId:N,questionCount:w});F(e)}catch(e){console.error("Error creating quiz session:",e)}})()},[j,N,E.length,w,O,U]),a.useEffect(()=>{E.length>0&&q===Math.floor(.7*E.length)&&T("mixed",15).catch(console.warn)},[q,E.length,T]);if(!j)return i.jsxs("div",{className:"flex flex-col items-center justify-center h-screen",children:[i.jsx("p",{className:"text-lg text-gray-600 mb-4",children:"Please log in to take a quiz."}),i.jsx("button",{onClick:()=>f("/auth/login"),className:"bg-blue-600 text-white px-6 py-2 rounded-lg",children:"Log In"})]});if(!N)return i.jsxs("div",{className:"flex flex-col items-center justify-center h-screen",children:[i.jsx("p",{className:"text-lg text-gray-600 mb-4",children:"No category selected."}),i.jsx("button",{onClick:()=>f("/categories"),className:"bg-blue-600 text-white px-6 py-2 rounded-lg",children:"Select Category"})]});if($)return i.jsxs("div",{className:"flex flex-col justify-center items-center h-screen",children:[i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"}),i.jsx("p",{className:"text-gray-600",children:"Loading quiz questions..."}),P&&i.jsx("p",{className:"text-sm text-gray-500",children:"Fetching latest questions"})]});if(K&&0===E.length){const e=B(N,w);return i.jsxs("div",{className:"flex flex-col items-center justify-center h-screen",children:[i.jsx(o,{className:"h-12 w-12 text-red-500 mb-4"}),i.jsx("p",{className:"text-lg text-red-600 mb-4",children:e?"Network error, but offline questions available":"Error loading quiz questions"}),i.jsx("p",{className:"text-sm text-gray-500 mb-4",children:D?.message}),e?i.jsx("button",{onClick:()=>window.location.reload(),className:"bg-blue-600 text-white px-6 py-2 rounded-lg mb-2",children:"Use Offline Questions"}):null,i.jsx("button",{onClick:()=>f("/categories"),className:"bg-gray-600 text-white px-6 py-2 rounded-lg",children:"Back to Categories"})]})}if(0===E.length)return i.jsxs("div",{className:"flex flex-col items-center justify-center h-screen",children:[i.jsx("p",{className:"text-lg text-gray-600 mb-4",children:"No questions found for this category."}),i.jsx("button",{onClick:()=>f("/categories"),className:"bg-blue-600 text-white px-6 py-2 rounded-lg",children:"Try Another Category"})]});const H=E[q],M=(q+1)/E.length*100;return i.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-3",children:i.jsxs("div",{className:"max-w-2xl mx-auto",children:[i.jsxs("div",{className:"flex items-center justify-between mb-3",children:[i.jsx("button",{onClick:()=>f(-1),className:"p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700",children:i.jsx(l,{size:20})}),i.jsxs("div",{className:"text-center",children:[i.jsxs("div",{className:"text-base font-bold flex items-center gap-2",children:[v||"Quiz",J&&i.jsx("div",{className:"flex items-center text-orange-500",title:"Using offline questions",children:i.jsx(o,{size:16})}),P&&i.jsx("div",{className:"flex items-center text-blue-500",title:"Updating questions",children:i.jsx(c,{size:16,className:"animate-pulse"})})]}),i.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Question ",q+1," / ",E.length]})]}),i.jsxs("div",{className:"text-right",children:[i.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Score"}),i.jsxs("div",{className:"text-base font-bold",children:[Q,"/",E.length]})]})]}),i.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mb-3 dark:bg-gray-700",children:i.jsx("div",{className:"bg-purple-600 h-2 rounded-full",style:{width:`${M}%`}})}),i.jsxs(m.div,{initial:{opacity:0,x:100},animate:{opacity:1,x:0},exit:{opacity:0,x:-100},transition:{duration:.5},className:"bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md",children:[i.jsx("h2",{className:"text-lg font-semibold mb-3",children:H.question_text}),i.jsx("div",{className:"flex flex-wrap gap-1 mb-3",children:H.question_tags.map(e=>i.jsx("span",{className:"bg-blue-100 text-blue-800 text-xs font-medium px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300",children:e.tags.name},e.tag_id))}),i.jsx("div",{className:"space-y-2",children:H.options&&H.options.map(e=>i.jsx("button",{onClick:()=>{return t=e.id,void(C||S(t));var t},disabled:C,className:`w-full text-left p-3 rounded-lg border-2 transition-all\n                  ${k===e.id?"border-blue-500 bg-blue-100 dark:bg-blue-900":"border-gray-300 dark:border-gray-600"}\n                  ${C&&e.id===H.correct_option_id?"bg-green-200 dark:bg-green-800 border-green-500":""}\n                  ${C&&k===e.id&&e.id!==H.correct_option_id?"bg-red-200 dark:bg-red-800 border-red-500":""}\n                  ${C?"cursor-not-allowed":"hover:bg-gray-100 dark:hover:bg-gray-700"}`,children:e.text},e.id))}),C&&H.explanation&&i.jsxs(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mt-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-700",children:[i.jsx("h3",{className:"font-bold mb-2 text-sm",children:"Explanation"}),i.jsx("p",{className:"text-sm",children:H.explanation})]}),i.jsx("div",{className:"mt-4 text-center",children:C?i.jsx("button",{onClick:async()=>{if(q<E.length-1)I(q+1),S(null),_(!1);else{const t=k===E[q].correct_option_id?Q+1:Q;try{O&&!J&&await L.mutateAsync({sessionId:O.id,userId:j.id,finalScore:t}),f("/results",{state:{score:t,totalQuestions:E.length,sessionId:O?.id,isOffline:J}})}catch(e){console.error("Error completing quiz:",e),f("/results",{state:{score:t,totalQuestions:E.length,isOffline:!0}})}}},className:"w-full bg-blue-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:q<E.length-1?"Next Question":"Finish Quiz"}):i.jsx("button",{onClick:async()=>{if(null===k)return;const e=E[q],t=k===e.correct_option_id;t&&z(Q+1),_(!0);try{O&&!J&&(A.mutate({sessionId:O.id,questionId:e.id,selectedOptionId:k,isCorrect:t,responseOrder:q+1}),W.mutate({userId:j.id,questionId:e.id,selectedOptionId:k,isCorrect:t}))}catch(s){console.error("Error recording answer:",s)}},disabled:null===k,className:"w-full bg-green-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed",children:"Submit Answer"})})]},q)]})})};export{j as default};
